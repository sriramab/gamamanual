<html><!-- Online page at https://github.com/gama-platform/gama/wiki/Tutorials/Tutorials/IncrementalModel/IncrementalModel_step5 --><head><meta charset="utf-8"><title>IncrementalModel_step5</title><script src="../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="incrementalmodel_step5">IncrementalModel_step5</h1>
<a class="dashAnchor" name="//apple_ref/Section/5.%20Visualizing%20in%203D"></a><h1 id="5-visualizing-in-3d">5. Visualizing in 3D</h1>
<p>This step Illustrates how to define a 3D display</p>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Formulation"></a><h2 id="formulation">Formulation</h2>
<ul>
<li>add a variable (height: int from 10m to 20m) and modify the aspect of buildings to display them in 3D
<ul>
<li>add a variable (display_shape: geometry; shape with a buffer of 2m) and modify the aspect of the roads to display them with this new shape.</li>
<li>add a new global variable that indicate if it is night or not (bool: night before 7h and after 20h).</li>
<li>define a new aspect (sphere3D) for people to display them as sphere.</li>
<li>modify the display to use this new aspect.</li>
</ul>
</li>
</ul>
<p><img src="../../../../github.com/wiki/gama-platform/gama/Tutorials/Tutorials/IncrementalModel/resources/images/tutorials/Incremental_model5.jpg" alt="images/Incremental_model5.jpg"></p>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Model%20Definition"></a><h2 id="model-definition">Model Definition</h2>
<a class="dashAnchor" name="//apple_ref/Section/building"></a><h3 id="building">building</h3>
<p>First, we add a new variable for buildings (<strong>height</strong>) of type float from 10m to 20m. Then we modify the aspect in order to specify a depth for the geometry (using the <strong>depth</strong> facet).</p>
<pre><code class="hljs processing">species building {
    <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> <span class="hljs-built_in"><span class="hljs-built_in">height</span></span> &lt;- <span class="hljs-number"><span class="hljs-number">10</span></span>#m + rnd(<span class="hljs-number"><span class="hljs-number">10</span></span>) #m;
    aspect geom {
        <span class="hljs-title"><span class="hljs-title">draw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">shape</span></span> <span class="hljs-built_in"><span class="hljs-built_in">color</span></span>: #gray depth: <span class="hljs-built_in"><span class="hljs-built_in">height</span></span>;
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/road"></a><h3 id="road">road</h3>
<p>Concerning the road,  we add a new variable (<strong>display_shape</strong>) of type geometry that correspond to the shape of the road with a buffer of 2 meters. Then we modify the aspect in order to display this geometry instead of the shape of the agent. In order to avoid "z-fighting" problems, we add a depth to the geometry (of 3 meters).</p>
<pre><code class="hljs mipsasm">species road {
    geometry <span class="hljs-keyword"><span class="hljs-keyword">display_shape </span></span>&lt;- <span class="hljs-keyword"><span class="hljs-keyword">shape </span></span>+ <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-comment"><span class="hljs-comment">;</span></span>
    aspect geom {
        draw <span class="hljs-keyword"><span class="hljs-keyword">display_shape </span></span>color: <span class="hljs-comment"><span class="hljs-comment">#black depth: 3.0;</span></span>
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/global%20variable"></a><h3 id="global-variable">global variable</h3>
<p>We define a new global variable called <strong>is_night</strong> of type <em>bool</em> to indicate if it is night or not. This variable will be update at each simulation step and will be <em>true</em> if the <strong>current_hour</strong> is lower than 7h or higher than 20h.</p>
<pre><code class="hljs lasso"><span class="hljs-built_in"><span class="hljs-built_in">global</span></span>{
    <span class="hljs-attr"><span class="hljs-attr">...</span></span>
        bool is_night &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span> update: current_hour &lt; <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> current_hour &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>;
       <span class="hljs-attr"><span class="hljs-attr">...</span></span>
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/people"></a><h3 id="people">people</h3>
<p>We define a new aspect for the people agent called <strong>sphere3D</strong>. This aspect draw people agent as a 3m sphere. In order to avoid to cut the sphere in half, we translate the centroid of the drawn sphere to 3m along the z axis.</p>
<pre><code class="hljs less"><span class="hljs-selector-tag"><span class="hljs-selector-tag">species</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">people</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">skills</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[moving]</span></span>{     
    ...
    <span class="hljs-selector-tag"><span class="hljs-selector-tag">aspect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sphere3D</span></span>{
        <span class="hljs-selector-tag"><span class="hljs-selector-tag">draw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sphere</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span>: {location<span class="hljs-selector-class"><span class="hljs-selector-class">.x</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">location</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.y</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">location</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.z</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">3</span></span>} <span class="hljs-attribute"><span class="hljs-attribute">color</span></span>:is_infected ? #<span class="hljs-attribute"><span class="hljs-attribute">red </span></span>: #green;
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/display"></a><h3 id="display">display</h3>
<p>The element that we have to modify is the display. We change its name to <strong>map_3D</strong> to better reflect its visual aspect.</p>
<p>In order to get a 3D aspect, we specify that this display will be an opengl one. For that, we just have to add the facet <strong>type: opengl</strong>. In addition, to get a different light between night and day : 
The statement <code>light</code> allows us to declare a light. We can change up to 7 lights, called through the facet "id". The default light is a white light, directional, with the id=1. You can set the intensity of the light through the facet "color" (you can pass a color, or an integer between 0 and 255). To have a nice effect night / day, we will set the intensity of the light to 50 during the night, and 255 for the day. To learn more about light, please read this <a href="https://github.com/wiki/gama-platform/gama/Tutorials/Tutorials/IncrementalModel/ManipulateLight.html">page</a>.</p>
<p>Then, we add a new layer that consists in an image (soil.jpg) by using the <strong>image</strong> statement.
In order to see the people inside the building, we add transparency to the building (0.5). The transparency of a layer is a float value between 0 (solid) and 1 (totally transparent). In order to be able to manage this transparency aspect, opengl has to draw the people agents before the building, thus we modify the order of drawing of the different layers (people agents before building agents). At last, we modify the aspect of the people agents by the new one: <strong>sphere3D</strong>.</p>
<pre><code class="hljs groovy">experiment main_experiment <span class="hljs-string"><span class="hljs-string">type:</span></span>gui{
    ...
    output {
        ...
        display map_3D <span class="hljs-string"><span class="hljs-string">type:</span></span> opengl {
            light <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">color:</span></span>(is_night ? 50 : <span class="hljs-number"><span class="hljs-number">255</span></span>);
            image <span class="hljs-string"><span class="hljs-string">"../includes/soil.jpg"</span></span>;
            species road <span class="hljs-string"><span class="hljs-string">aspect:</span></span>geom;
            species people <span class="hljs-string"><span class="hljs-string">aspect:</span></span>sphere3D;         
            species building <span class="hljs-string"><span class="hljs-string">aspect:</span></span>geom <span class="hljs-string"><span class="hljs-string">transparency:</span></span> <span class="hljs-number"><span class="hljs-number">0.5</span></span>;
        }
        ...
    }
}
</code></pre>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Complete%20Model"></a><h2 id="complete-model">Complete Model</h2>
<pre><code class="hljs cs">model model5 
 
global {
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people &lt;- <span class="hljs-number"><span class="hljs-number">500</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> step &lt;- <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-meta"><span class="hljs-meta">#minutes;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infection_distance &lt;- <span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-meta"><span class="hljs-meta">#m;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> proba_infection &lt;- <span class="hljs-number"><span class="hljs-number">0.05</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_infected_init &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span>;
    file roads_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/road.shp"</span></span>);
    file buildings_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/building.shp"</span></span>);
    geometry shape &lt;- envelope(roads_shapefile);
    graph road_network;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> current_hour update: (cycle / <span class="hljs-number"><span class="hljs-number">60</span></span>) mod <span class="hljs-number"><span class="hljs-number">24</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> staying_coeff update: <span class="hljs-number"><span class="hljs-number">10.0</span></span> ^ (<span class="hljs-number"><span class="hljs-number">1</span></span> + min([abs(current_hour - <span class="hljs-number"><span class="hljs-number">9</span></span>), abs(current_hour - <span class="hljs-number"><span class="hljs-number">12</span></span>), abs(current_hour - <span class="hljs-number"><span class="hljs-number">18</span></span>)]));
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_infected &lt;- nb_infected_init update: <span class="hljs-function"><span class="hljs-function">people </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each.is_infected</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_not_infected &lt;- nb_people - nb_infected_init update: nb_people - nb_people_infected;
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_night &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span> update: current_hour &lt; <span class="hljs-number"><span class="hljs-number">7</span></span> or current_hour &gt; <span class="hljs-number"><span class="hljs-number">20</span></span>;
    
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infected_rate update: nb_people_infected/length(people);
    init {
        create road <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: roads_shapefile;
        road_network &lt;- as_edge_graph(road);
        create building <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: buildings_shapefile;
        create people number:nb_people {
            speed &lt;- <span class="hljs-number"><span class="hljs-number">5.0</span></span> <span class="hljs-meta"><span class="hljs-meta">#km/#h;</span></span>
            building bd &lt;- one_of(building);
            location &lt;- any_location_in(bd);
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        }
    }
    reflex end_simulation <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: infected_rate = <span class="hljs-number"><span class="hljs-number">1.0</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> halt;
    }
}

species people skills:[moving]{     
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    point target;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> staying_counter;
    reflex stay <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: target = nil {
        staying_counter &lt;- staying_counter + <span class="hljs-number"><span class="hljs-number">1</span></span>;
        <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">staying_counter / staying_coeff</span></span></span><span class="hljs-function">) </span></span>{
            target &lt;- any_location_in (one_of(building));
        }
    }
        
    reflex move <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: target != nil{
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> target:target on: road_network;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location = target) {
            target &lt;- nil;
            staying_counter &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span>;
        } 
    }
    reflex infect <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: is_infected{
        ask people at_distance infection_distance {
            <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proba_infection</span></span></span><span class="hljs-function">) </span></span>{
                is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
            }
        }
    }
    aspect circle{
        <span class="hljs-function"><span class="hljs-function">draw </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">circle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span></span><span class="hljs-function">) color:is_infected ? #red : #green</span></span>;
    }
    aspect sphere3D{
        <span class="hljs-function"><span class="hljs-function">draw </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sphere</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span></span><span class="hljs-function">) at: </span></span>{location.x,location.y,location.z + <span class="hljs-number"><span class="hljs-number">3</span></span>} color:is_infected ? <span class="hljs-meta"><span class="hljs-meta">#red : #green;</span></span>
    }
}

species road {
    geometry display_shape &lt;- shape + <span class="hljs-number"><span class="hljs-number">2.0</span></span>;
    aspect geom {
        draw display_shape color: <span class="hljs-meta"><span class="hljs-meta">#black depth: 3.0;</span></span>
    }
}

species building {
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> height &lt;- <span class="hljs-number"><span class="hljs-number">10</span></span><span class="hljs-meta"><span class="hljs-meta">#m + rnd(10) #m;</span></span>
    aspect geom {
        draw shape color: <span class="hljs-meta"><span class="hljs-meta">#gray depth: height;</span></span>
    }
}

experiment main_experiment type:gui{
    parameter <span class="hljs-string"><span class="hljs-string">"Infection distance"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: infection_distance;
    parameter <span class="hljs-string"><span class="hljs-string">"Proba infection"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: proba_infection min: <span class="hljs-number"><span class="hljs-number">0.0</span></span> max: <span class="hljs-number"><span class="hljs-number">1.0</span></span>;
    parameter <span class="hljs-string"><span class="hljs-string">"Nb people infected at init"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: nb_infected_init ;
    output {
        monitor <span class="hljs-string"><span class="hljs-string">"Current hour"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: current_hour;
        monitor <span class="hljs-string"><span class="hljs-string">"Infected people rate"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: infected_rate;
        display map_3D type: opengl {
            light <span class="hljs-number"><span class="hljs-number">1</span></span> color:(is_night ? <span class="hljs-number"><span class="hljs-number">50</span></span> : <span class="hljs-number"><span class="hljs-number">255</span></span>);
            image <span class="hljs-string"><span class="hljs-string">"../includes/soil.jpg"</span></span>;
            species road aspect:geom;
            species people aspect:sphere3D;         
            species building aspect:geom transparency: <span class="hljs-number"><span class="hljs-number">0.5</span></span>;
        }
        display chart refresh:every(<span class="hljs-number"><span class="hljs-number">10</span></span>) {
            chart <span class="hljs-string"><span class="hljs-string">"Disease spreading"</span></span> type: series {
                data <span class="hljs-string"><span class="hljs-string">"susceptible"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_not_infected color: <span class="hljs-meta"><span class="hljs-meta">#green;</span></span>
                data <span class="hljs-string"><span class="hljs-string">"infected"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_infected color: <span class="hljs-meta"><span class="hljs-meta">#red;</span></span>
            }
        }
    }
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>