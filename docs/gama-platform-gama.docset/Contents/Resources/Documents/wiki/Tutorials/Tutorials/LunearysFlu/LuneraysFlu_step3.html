<html><!-- Online page at https://github.com/gama-platform/gama/wiki/Tutorials/Tutorials/LunearysFlu/LuneraysFlu_step3 --><head><meta charset="utf-8"><title>LuneraysFlu_step3</title><script src="../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="luneraysflu_step3">LuneraysFlu_step3</h1>
<a class="dashAnchor" name="//apple_ref/Section/3.%20Importation%20of%20GIS%20data"></a><h1 id="3-importation-of-gis-data">3. Importation of GIS data</h1>
<p>This third step illustrates how load GIS data and to agentify them.</p>
<p><img src="../../../../github.com/wiki/gama-platform/gama/Tutorials/Tutorials/LunearysFlu/resources/images/tutorials/luneray3.png" alt="images/luneray3.png"></p>
<a class="dashAnchor" name="//apple_ref/Section/Formulation"></a><h2 id="formulation">Formulation</h2>
<ul>
<li>Define 2 new species that will just be displayed: <em>road</em> and <em>building</em>.
<ul>
<li>Define new global attributes to load GIS data (shape file).</li>
<li>Use the GIS data to create the <em>road</em> and <em>building</em> agents.</li>
<li>Add the <em>road</em> and <em>building</em> agents to the display.</li>
</ul>
</li>
</ul>
<a class="dashAnchor" name="//apple_ref/Section/Model%20Definition"></a><h2 id="model-definition">Model Definition</h2>
<p>For this step, you will need to add the shapefiles of the roads and buildings inside the <em>includes</em> folder of the project. The shapefiles (and all the other files) can be found <a href="https://github.com/gama-platform/gama/wiki/resources/other/models/Luneray_flu.zip">here</a>. </p>
<a class="dashAnchor" name="//apple_ref/Section/species"></a><h3 id="species">species</h3>
<p>In this model, we have to define two species of agents: the <strong>road</strong> agents and the <strong>building</strong> ones. These agents will not have a particular behavior, they will just be displayed.
For each of this species we define an aspect called <em>geom</em>. As we want to represent the geometry of the agent, we then use the keyword <strong>draw</strong> that allow to draw a given geometry. In order to draw the geometry of the agent we use the attribute <strong>shape</strong> (which is a built-in attribute of all agents). The road will be displayed in black and the building in gray.</p>
<pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">species</span></span> road {
    <span class="hljs-attribute"><span class="hljs-attribute">aspect</span></span> geom {
        <span class="hljs-attribute"><span class="hljs-attribute">draw</span></span> shape color: <span class="hljs-comment"><span class="hljs-comment">#black;</span></span>
    }
}

species building {
    <span class="hljs-attribute"><span class="hljs-attribute">aspect</span></span> geom {
        <span class="hljs-attribute"><span class="hljs-attribute">draw</span></span> shape color: <span class="hljs-comment"><span class="hljs-comment">#gray;</span></span>
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/global%20section"></a><h3 id="global-section">global section</h3>
<a class="dashAnchor" name="//apple_ref/Section/global%20variables"></a><h4 id="global-variables">global variables</h4>
<p>GAMA allows to automatically read GIS data that are formatted as shape files (or as OSM file). In our model, we define 2 shapefiles: one corresponding to the roads and the other ones to the buildings. Note that GAMA is able to manage the projection of the GIS data. 
In order to set the right size (and position) of the world geometry, we define its value as the envelope of the road shapefile (and no more a square of 1500 meters).</p>
<pre><code class="hljs stata"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//... other attributes</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> roads_shapefile &lt;- <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>(<span class="hljs-string"><span class="hljs-string">"../includes/routes.shp"</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> buildings_shapefile &lt;- <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>(<span class="hljs-string"><span class="hljs-string">"../includes/batiments.shp"</span></span>);
    geometry shape &lt;- envelope(roads_shapefile);    
    <span class="hljs-comment"><span class="hljs-comment">//... init</span></span>
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/agentification%20of%20GIS%20data"></a><h3 id="agentification-of-gis-data">agentification of GIS data</h3>
<p>In GAMA, the agentification of GIS data is very straightforward: it only requires to use the <strong>create</strong> command with the <strong>from</strong> facet to pass the shapefile. Each object of the shapefile will be directly used to instantiate an agent of the specified species. The reading of an attribute in a shapefile is also very simple. It only requires to use the <strong>with</strong> facet: the argument of this facet is a dictionary of which the keys are the names of the agent attributes and the value the <strong>read</strong> command followed by the name of the shapefile attribute.</p>
<p>In our model, we modify the init section in order to first create the <em>road</em> agents from the road shapefile, and the <em>building</em> agents from the building shapefile. Then, when creating people agents, we choose for them a random location inside a random building.
Note that it is possible to execute a sequence of statements at the creation of agents by using a block ({...}) rather than a simple line (;) when using the <em>create</em> statement. </p>
<pre><code class="hljs sqf">global {
    <span class="hljs-comment"><span class="hljs-comment">// world variable definition</span></span>

    init{
        create road <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: roads_shapefile;
        create building <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: buildings_shapefile;
        create people number:nb_people {
            <span class="hljs-built_in"><span class="hljs-built_in">location</span></span> &lt;- any_location_in(one_of(building));      }       
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        }
    }
}
</code></pre>
<p>We used here the <a href="https://github.com/wiki/gama-platform/gama/Tutorials/Tutorials/LunearysFlu/Operators#one_of.html">one_of</a> operator that returns a random element from a list and the <a href="https://github.com/wiki/gama-platform/gama/Tutorials/Tutorials/LunearysFlu/Operators#any_location_in.html">any_location_in</a> operator that returns a random location inside a geometry.</p>
<a class="dashAnchor" name="//apple_ref/Section/experiment"></a><h3 id="experiment">experiment</h3>
<a class="dashAnchor" name="//apple_ref/Section/Output"></a><h4 id="output">Output</h4>
<p>In the <em>map</em> display, we add the <em>road</em> and <em>building</em> species with their <em>geom</em> aspect just before the <em>people</em> species (in order to draw the people agents on the top of the roads and buildings). </p>
<pre><code class="hljs less"><span class="hljs-selector-tag"><span class="hljs-selector-tag">experiment</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main_experiment</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">gui</span></span> {
    ... <span class="hljs-comment"><span class="hljs-comment">//parameter definition</span></span>

    <span class="hljs-selector-tag"><span class="hljs-selector-tag">output</span></span> {
    ... <span class="hljs-comment"><span class="hljs-comment">//monitor definition</span></span>

        <span class="hljs-selector-tag"><span class="hljs-selector-tag">display</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">map</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">type</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">opengl</span></span>{
            species road <span class="hljs-attribute"><span class="hljs-attribute">aspect</span></span>:geom;
            species building <span class="hljs-attribute"><span class="hljs-attribute">aspect</span></span>:geom;
            species people <span class="hljs-attribute"><span class="hljs-attribute">aspect</span></span>:circle;           
        }
        ... <span class="hljs-comment"><span class="hljs-comment">//chart display definition</span></span>
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/Complete%20Model"></a><h2 id="complete-model">Complete Model</h2>
<pre><code class="hljs cs">model model3

global {
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people &lt;- <span class="hljs-number"><span class="hljs-number">2147</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_infected_init &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> step &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-meta"><span class="hljs-meta">#mn;</span></span>
    file roads_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/roads.shp"</span></span>);
    file buildings_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/buildings.shp"</span></span>);
    geometry shape &lt;- envelope(roads_shapefile);    
    
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_infected &lt;- nb_infected_init update: <span class="hljs-function"><span class="hljs-function">people </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each.is_infected</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_not_infected &lt;- nb_people - nb_infected_init update: nb_people - nb_people_infected;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infected_rate update: nb_people_infected/nb_people;
    
    
    init{
        create road <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: roads_shapefile;
        create building <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: buildings_shapefile;
        create people number:nb_people {
            location &lt;- any_location_in(one_of(building));              
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        }
    }
}

species people skills:[moving]{     
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> speed &lt;- (<span class="hljs-number"><span class="hljs-number">2</span></span> + rnd(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-meta"><span class="hljs-meta">#km/#h;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    
    reflex move{
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> wander;
    }

    reflex infect <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: is_infected{
        ask people at_distance <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-meta"><span class="hljs-meta">#m {</span></span>
            <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.05</span></span></span></span></span><span class="hljs-function">) </span></span>{
                is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
            }
        }
    }
    
    aspect circle {
        <span class="hljs-function"><span class="hljs-function">draw </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">circle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">10</span></span></span></span></span><span class="hljs-function">) color:is_infected ? #red : #green</span></span>;
    }
}

species road {
    aspect geom {
        draw shape color: <span class="hljs-meta"><span class="hljs-meta">#black;</span></span>
    }
}

species building {
    aspect geom {
        draw shape color: <span class="hljs-meta"><span class="hljs-meta">#gray;</span></span>
    }
}

experiment main type: gui {
    parameter <span class="hljs-string"><span class="hljs-string">"Nb people infected at init"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: nb_infected_init min: <span class="hljs-number"><span class="hljs-number">1</span></span> max: <span class="hljs-number"><span class="hljs-number">2147</span></span>;

    output {
        monitor <span class="hljs-string"><span class="hljs-string">"Infected people rate"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: infected_rate;
        
        display map {
            species road aspect:geom;
            species building aspect:geom;
            species people aspect:circle;           
        }
        
        display chart_display refresh: every(<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-meta"><span class="hljs-meta">#cycle) {</span></span>
            chart <span class="hljs-string"><span class="hljs-string">"Disease spreading"</span></span> type: series {
                data <span class="hljs-string"><span class="hljs-string">"susceptible"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_not_infected color: <span class="hljs-meta"><span class="hljs-meta">#green;</span></span>
                data <span class="hljs-string"><span class="hljs-string">"infected"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_infected color: <span class="hljs-meta"><span class="hljs-meta">#red;</span></span>
            }
        }
    }
}
</code></pre>
<p><a href="LuneraysFlu_step4.html">Next step: Use of a graph to constraint the movements of people</a></p>
<script>hljs.initHighlightingOnLoad();</script></body></html>