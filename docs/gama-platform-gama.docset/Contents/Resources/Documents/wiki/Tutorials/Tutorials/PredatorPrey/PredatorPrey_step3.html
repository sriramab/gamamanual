<html><!-- Online page at https://github.com/gama-platform/gama/wiki/Tutorials/Tutorials/PredatorPrey/PredatorPrey_step3 --><head><meta charset="utf-8"><title>PredatorPrey_step3</title><script src="../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="predatorprey_step3">PredatorPrey_step3</h1>
<a class="dashAnchor" name="//apple_ref/Section/3.%20Prey%20Agent%20Behavior"></a><h1 id="3-prey-agent-behavior">3. Prey Agent Behavior</h1>
<p>This third step Illustrates how to define the behaviors of prey agents and the concept of spatial topology.</p>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Formulation"></a><h2 id="formulation">Formulation</h2>
<ul>
<li>Random movement of the prey agents to a distance of 2 cells (Von Neumann neighborhood)
<ul>
<li>At each step, the prey agents loss energy</li>
<li>At each step, the prey agents eat food if there is food on the cell on which they are localized (with a max of max_transfer) and gain energy</li>
<li>If a prey agent has no more energy, it dies</li>
</ul>
</li>
</ul>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Model%20Definition"></a><h2 id="model-definition">Model Definition</h2>
<a class="dashAnchor" name="//apple_ref/Section/parameters"></a><h3 id="parameters">parameters</h3>
<p>To define a behavior for the prey agents we add them three new parameters:</p>
<ul>
<li>The max energy of the prey agents
<ul>
<li>The maximum energy that can a prey agent consume from vegetation per tick</li>
<li>The energy used by a prey agent at each time step</li>
</ul>
</li>
</ul>
<p>As we consider these parameters to be global to all prey, we define them in the  global section as follows:</p>
<pre><code class="hljs irpf90">   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> prey_max_energy &lt;- <span class="hljs-number"><span class="hljs-number">1.0</span></span>;
   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> prey_max_transfer &lt;- <span class="hljs-number"><span class="hljs-number">0.1</span></span>;
   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> prey_energy_consum &lt;- <span class="hljs-number"><span class="hljs-number">0.05</span></span>;
   
</code></pre>
<p>Yet we may allow the user to change it from an experiment to another through the user interface. To do so we add the following definition of parameters within the experiment section :</p>
<pre><code class="hljs gams">   <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> <span class="hljs-string"><span class="hljs-string">"Prey max energy: "</span></span> var: prey_max_energy <span class="hljs-comment"><span class="hljs-comment">category:</span></span> <span class="hljs-comment"><span class="hljs-comment">"Prey"</span></span> ;
   <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> <span class="hljs-string"><span class="hljs-string">"Prey max transfer: "</span></span> var: prey_max_transfer  <span class="hljs-comment"><span class="hljs-comment">category:</span></span> <span class="hljs-comment"><span class="hljs-comment">"Prey"</span></span> ;
   <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> <span class="hljs-string"><span class="hljs-string">"Prey energy consumption: "</span></span> var: prey_energy_consum  <span class="hljs-comment"><span class="hljs-comment">category:</span></span> <span class="hljs-comment"><span class="hljs-comment">"Prey"</span></span> ;
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/vegetation_cell%20grid"></a><h3 id="vegetation_cell-grid">vegetation_cell grid</h3>
<p>We add a new variable for the vegetation_cell grid called <strong>neighbours</strong>, that contains for each vegetation cell the list of the neighbor vegetation cells (distance of 2 - Von Neumann neighborhood). We will use these neighbors list for the movement of the prey.</p>
<pre><code class="hljs groovy">  grid vegetation_cell <span class="hljs-string"><span class="hljs-string">width:</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-string"><span class="hljs-string">height:</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-string"><span class="hljs-string">neighbours:</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> {
      ...
      list&lt;vegetation_cell&gt; neighbours &lt;- self neighbours_at <span class="hljs-number"><span class="hljs-number">2</span></span>;
   }
</code></pre>
<p>Note that the result of the operator <strong>neighbours_at dist</strong> depends on the type of topology of the agent applying this operator:</p>
<ul>
<li>For a grid topology (grid species), the operator returns the neighbor cells (with a Von Neumann or Moore neighborhood).
<ul>
<li>For a continuous topology, the operator returns the list of agents of which the shape is located at a distance equals or inferior <em>dist</em> meters to the agent shape.</li>
</ul>
</li>
</ul>
<p>Also note the use of the <a href="https://github.com/wiki/gama-platform/gama/Tutorials/Tutorials/PredatorPrey/PseudoVariables#self.html">self</a> pseudo variable which is a reference to the agent currently executing the statement</p>
<a class="dashAnchor" name="//apple_ref/Section/Prey%20agents"></a><h2 id="prey-agents">Prey agents</h2>
<p>We copy the values of the three global parameters into the prey species in order for it to be available for each agent and possibly modified locally.</p>
<pre><code class="hljs irpf90">species prey {
   ...
   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> max_energy &lt;- prey_max_energy ;
   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> max_transfer &lt;- prey_max_transfer ;
   <span class="hljs-built_in"><span class="hljs-built_in">float</span></span> energy_consum &lt;- prey_energy_consum ;
   ...
}       
</code></pre>
<p>The energy used by each prey at each timestep is randomly computed initially (within ]0;max_energy]).</p>
<pre><code class="hljs groovy">species prey {
   ...
   <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> energy &lt;- (rnd(<span class="hljs-number"><span class="hljs-number">1000</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>) * max_energy  <span class="hljs-string"><span class="hljs-string">update:</span></span> energy - energy_consum <span class="hljs-string"><span class="hljs-string">max:</span></span> max_energy ;
   ...
}    
</code></pre>
<p>In order to define the movement behaviour of a prey we will add a <strong>reflex</strong>. A reflex is a block of statements (that can be defined in global or any species) that will be automatically executed at each simulation step if its condition is true, it is defined as follows:</p>
<pre><code class="hljs nimrod">   reflex reflex_name <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: condition <span class="hljs-meta"><span class="hljs-meta">{...}</span></span>
</code></pre>
<p>The <strong>when</strong> facet is optional: when it is omitted, the reflex is activated at each time step. Note that if several reflexes are defined for a species, the reflexes will be activated following their definition order.</p>
<p>We define a first reflex called <strong>basic_move</strong> that allows the prey agents to choose (randomly) a new vegetation_cell in the neighborhood of my_cell and to move to this cell.</p>
<pre><code class="hljs mipsasm">species prey {
   ...
   reflex <span class="hljs-keyword"><span class="hljs-keyword">basic_move </span></span>{ 
       myCell &lt;- one_of (myCell.neighbours) <span class="hljs-comment"><span class="hljs-comment">;</span></span>
       location &lt;- myCell.location <span class="hljs-comment"><span class="hljs-comment">;</span></span>
   }
}
</code></pre>
<p>We define a second reflex called <strong>eat</strong> that will only be activated when there is food in my_cell and that will allows the prey agents to eat food and gain energy. In order to store the energy gain by the eating (that is equals to the minimum between the <strong>max_transfer</strong> value and the quantity of food available in <strong>myCell</strong>), we define a local variable called <strong>energy_transfer</strong>.  A local variable is a variable that will only exist within this block: once it has been executed, the variable is forgotten. To define it, we have to use the following statement:</p>
<pre><code class="hljs irpf90">var_type var_name &lt;- <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; 
</code></pre>
<p>Thus, the reflex <strong>eat</strong> is defined by:</p>
<pre><code class="hljs mipsasm">species prey {
   ...
   reflex eat when: myCell.food &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { 
      float energy_transfer &lt;- min([max_transfer, myCell.food]) <span class="hljs-comment"><span class="hljs-comment">;</span></span>
      myCell.food &lt;- myCell.food - energy_transfer <span class="hljs-comment"><span class="hljs-comment">;</span></span>
      energy &lt;- energy + energy_transfer <span class="hljs-comment"><span class="hljs-comment">;</span></span>
   }
}
</code></pre>
<p>We define a third reflex for the prey agent: when the agent has no more energy, it dies (application of the built-in <strong>die</strong> action):</p>
<pre><code class="hljs perl">species prey {
   ...
   reflex <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: energy &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> {
      <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> ;
   }
}
</code></pre>
<p>Note that an action is a capability available to the agents of a species (what they can do). It is a block of statements that can be used and reused whenever needed. Some actions, called primitives, are directly coded in Java: for instance, the <strong>die</strong> action defined for all the agents.</p>
<ul>
<li>An action can accept arguments. For instance, write takes an argument called message.
<ul>
<li>An action can return a result.</li>
</ul>
</li>
</ul>
<p>There are two ways to call an action: using a statement or as part of an expression</p>
<ul>
<li>for actions that do not return a result:
<code>
do action_name arg1: v1 arg2: v2;
</code>
<ul>
<li>for actions that return a result:
<code>
my_var &lt;- self action_name (arg1:v1, arg2:v2);
</code></li>
</ul>
</li>
</ul>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Complete%20Model"></a><h2 id="complete-model">Complete Model</h2>
<pre><code class="hljs mel">model prey_predator

<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_preys_init &lt;- <span class="hljs-number"><span class="hljs-number">200</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> prey_max_energy &lt;- <span class="hljs-number"><span class="hljs-number">1.0</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> prey_max_transfer &lt;- <span class="hljs-number"><span class="hljs-number">0.1</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> prey_energy_consum &lt;- <span class="hljs-number"><span class="hljs-number">0.05</span></span>;
    
    init {
        create prey number: nb_preys_init ;
    }
}

species prey {
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> &lt;- <span class="hljs-number"><span class="hljs-number">1.0</span></span> ;
    rgb <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> &lt;- #blue;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> max_energy &lt;- prey_max_energy ;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> max_transfer &lt;- prey_max_transfer ;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> energy_consum &lt;- prey_energy_consum ;
        
    vegetation_cell myCell &lt;- one_of (vegetation_cell) ; 
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> energy &lt;- (rnd(<span class="hljs-number"><span class="hljs-number">1000</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>) * max_energy  update: energy - energy_consum <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>: max_energy ;
        
    init { 
        location &lt;- myCell.location;
    }
        
    reflex basic_move { 
        myCell &lt;- one_of (myCell.neighbours) ;
        location &lt;- myCell.location ;
    }
    reflex eat when: myCell.food &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> { 
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> energy_transfer &lt;- <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([max_transfer, myCell.food]) ;
        myCell.food &lt;- myCell.food - energy_transfer ;
        energy &lt;- energy + energy_transfer ;
    }
    reflex die when: energy &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> die ;
    }

    aspect base {
        draw <span class="hljs-keyword"><span class="hljs-keyword">circle</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">color</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> ;
    }
}

<span class="hljs-keyword"><span class="hljs-keyword">grid</span></span> vegetation_cell width: <span class="hljs-number"><span class="hljs-number">50</span></span> height: <span class="hljs-number"><span class="hljs-number">50</span></span> neighbours: <span class="hljs-number"><span class="hljs-number">4</span></span> {
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> maxFood &lt;- <span class="hljs-number"><span class="hljs-number">1.0</span></span> ;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> foodProd &lt;- (rnd(<span class="hljs-number"><span class="hljs-number">1000</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>) * <span class="hljs-number"><span class="hljs-number">0.01</span></span> ;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> food &lt;- (rnd(<span class="hljs-number"><span class="hljs-number">1000</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>: maxFood update: food + foodProd ;
    rgb <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> &lt;- rgb(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> - food)), <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> - food))) update: rgb(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> - food)), <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span> *(<span class="hljs-number"><span class="hljs-number">1</span></span> - food))) ;
    list&lt;vegetation_cell&gt; neighbours  &lt;- (self neighbours_at <span class="hljs-number"><span class="hljs-number">2</span></span>);
}

experiment prey_predator type: gui {
    parameter <span class="hljs-string"><span class="hljs-string">"Initial number of preys: "</span></span> var: nb_preys_init <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span> category: <span class="hljs-string"><span class="hljs-string">"Prey"</span></span> ;
    parameter <span class="hljs-string"><span class="hljs-string">"Prey max energy: "</span></span> var: prey_max_energy category: <span class="hljs-string"><span class="hljs-string">"Prey"</span></span> ;
    parameter <span class="hljs-string"><span class="hljs-string">"Prey max transfer: "</span></span> var: prey_max_transfer  category: <span class="hljs-string"><span class="hljs-string">"Prey"</span></span> ;
    parameter <span class="hljs-string"><span class="hljs-string">"Prey energy consumption: "</span></span> var: prey_energy_consum  category: <span class="hljs-string"><span class="hljs-string">"Prey"</span></span> ;
    output {
        display main_display {
            <span class="hljs-keyword"><span class="hljs-keyword">grid</span></span> vegetation_cell lines: #black ;
            species prey aspect: base ;
        }
    }
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>