<html><!-- Online page at https://github.com/gama-platform/gama/wiki/Tutorials/Tutorials/LunearysFlu/LuneraysFlu_step4 --><head><meta charset="utf-8"><title>LuneraysFlu_step4</title><script src="../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="luneraysflu_step4">LuneraysFlu_step4</h1>
<a class="dashAnchor" name="//apple_ref/Section/4.%20Use%20of%20a%20graph%20to%20constraint%20the%20movements%20of%20people"></a><h1 id="4-use-of-a-graph-to-constraint-the-movements-of-people">4. Use of a graph to constraint the movements of people</h1>
<p>This fourth step illustrates how to use a graph to constraint the movements of agents</p>
<p><img src="../../../../github.com/wiki/gama-platform/gama/Tutorials/Tutorials/LunearysFlu/resources/images/tutorials/luneray4.png" alt="images/luneray4.png"></p>
<table><thead><tr></tr></thead><tbody><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Formulation"></a><h2 id="formulation">Formulation</h2>
<ul>
<li>Define a new global variable: the road network (graph).
<ul>
<li>Build the road network graph from the road agents</li>
<li>Add new attribute to the people agents (target)</li>
<li>Define a new reflex for people agents: stay.</li>
<li>Modify the move reflex of the people agents.</li>
</ul>
</li>
</ul>
<a class="dashAnchor" name="//apple_ref/Section/Model%20Definition"></a><h2 id="model-definition">Model Definition</h2>
<a class="dashAnchor" name="//apple_ref/Section/global%20section"></a><h3 id="global-section">global section</h3>
<a class="dashAnchor" name="//apple_ref/Section/global%20variables"></a><h4 id="global-variables">global variables</h4>
<p>In this model, we want that people agents move from buildings to buildings by using the shortest path in the road network. In order to compute this shortest path, we need to use a graph structure.</p>
<p>We thus define a new global variable called <em>road_network</em> of type <em>graph</em> that will represent the road network.</p>
<pre><code class="hljs stata"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//... other attributes</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">graph</span></span> road_network;
    
    <span class="hljs-comment"><span class="hljs-comment">//... init</span></span>
}
</code></pre>
<p>In order to compute the graph from the road network, we use, just after having creating the road agents, the <a href="https://github.com/wiki/gama-platform/gama/Tutorials/Tutorials/LunearysFlu/Operators#as_edge_graph.html">as_edge_graph</a> operator. This operator automatically built a graph from a set of polylines. Each extremity point of the lines will become a node in the graph, and each polyline an edge. By default, the graph is not oriented and the weights of the edges are the perimeters of the polylines. It is of course possible to change through the use of some operators.  </p>
<pre><code class="hljs puppet"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> {
    // world variable definition

    init{
        create road from: roads_shapefile;
        road_network &lt;- as_edge_graph(road);        
        create building from: buildings_shapefile;
        create people number:nb_people {
            location &lt;- any_location_in(one_of(building));              
        }
        <span class="hljs-keyword"><span class="hljs-keyword">ask</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nb_infected_init</span></span> <span class="hljs-keyword"><span class="hljs-keyword">among</span></span> <span class="hljs-keyword"><span class="hljs-keyword">people</span></span> {
            is_infected &lt;- <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;
        }
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/people%20species"></a><h3 id="people-species">people species</h3>
<p>We want to modify the behavior of the people agents in order to make them move from buildings to buildings by using the shortest path in the road network. </p>
<a class="dashAnchor" name="//apple_ref/Section/variables"></a><h3 id="variables">variables</h3>
<p>In order to implement this behavior, we will add two variables to our people species:</p>
<ul>
<li><em>target</em> of type <em>point</em> that will be the location where the agent wants to go</li>
</ul>
<pre><code class="hljs less"><span class="hljs-selector-tag"><span class="hljs-selector-tag">species</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">people</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">skills</span></span>:<span class="hljs-selector-attr"><span class="hljs-selector-attr">[moving]</span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//...the other attributes</span></span>
    point target;
    <span class="hljs-comment"><span class="hljs-comment">//....</span></span>
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/behavior"></a><h3 id="behavior">behavior</h3>
<p>First, we add a new reflex called <em>stay</em> that will be activated when the agent is in a house (i.e. its target is null) and that will define with a probability of 0.05 if the agent has to go or not. If the agent has to go, it will randomly choose a new target (a random location inside one of the building). </p>
<pre><code class="hljs aspectj">reflex stay when: <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> = nil {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.05</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> &lt;- any_location_in (one_of(building));
    }
}
</code></pre>
<p>Then, we modify the <em>move</em> reflex. This one will be only activated when the agent will have to move (target not null). Instead of using the <em>wander</em> action of the <em>moving</em> skill, we use the <em>goto</em> one that allows to make an agent moves toward a given target. In addition, it is possible to add a facet <em>on</em> to precise on which topology the agent will have to move on. In our case, the topology is the road network.
When the agent reach its destination (location = target), it sets its target to null.</p>
<pre><code class="hljs irpf90">reflex move when: <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> <span class="hljs-comment"><span class="hljs-comment">!= nil{</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">target</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">target</span></span> on: road_network;
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location = <span class="hljs-keyword"><span class="hljs-keyword">target</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">target</span></span> &lt;- nil;
    } 
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/Complete%20Model"></a><h2 id="complete-model">Complete Model</h2>
<pre><code class="hljs cs">model model4 

global {
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people &lt;- <span class="hljs-number"><span class="hljs-number">2147</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_infected_init &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> step &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-meta"><span class="hljs-meta">#mn;</span></span>
    file roads_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/roads.shp"</span></span>);
    file buildings_shapefile &lt;- file(<span class="hljs-string"><span class="hljs-string">"../includes/buildings.shp"</span></span>);
    geometry shape &lt;- envelope(roads_shapefile);    
    graph road_network;
    
    
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_infected &lt;- nb_infected_init update: <span class="hljs-function"><span class="hljs-function">people </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each.is_infected</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_not_infected &lt;- nb_people - nb_infected_init update: nb_people - nb_people_infected;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infected_rate update: nb_people_infected/nb_people;
    
    
    init{
        create road <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: roads_shapefile;
        road_network &lt;- as_edge_graph(road);        
        create building <span class="hljs-keyword"><span class="hljs-keyword">from</span></span>: buildings_shapefile;
        create people number:nb_people {
            location &lt;- any_location_in(one_of(building));              
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        }
    }
}

species people skills:[moving]{     
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> speed &lt;- (<span class="hljs-number"><span class="hljs-number">2</span></span> + rnd(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-meta"><span class="hljs-meta">#km/#h;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    point target;
    
    reflex stay <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: target = nil {
        <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.05</span></span></span></span></span><span class="hljs-function">) </span></span>{
            target &lt;- any_location_in (one_of(building));
        }
    }
        
    reflex move <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: target != nil{
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> target:target on: road_network;
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location = target) {
            target &lt;- nil;
        } 
    }

    reflex infect <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: is_infected{
        ask people at_distance <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-meta"><span class="hljs-meta">#m {</span></span>
            <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0.05</span></span></span></span></span><span class="hljs-function">) </span></span>{
                is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
            }
        }
    }
    
    aspect circle {
        <span class="hljs-function"><span class="hljs-function">draw </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">circle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">10</span></span></span></span></span><span class="hljs-function">) color:is_infected ? #red : #green</span></span>;
    }
}

species road {
    aspect geom {
        draw shape color: <span class="hljs-meta"><span class="hljs-meta">#black;</span></span>
    }
}

species building {
    aspect geom {
        draw shape color: <span class="hljs-meta"><span class="hljs-meta">#gray;</span></span>
    }
}

experiment main type: gui {
    parameter <span class="hljs-string"><span class="hljs-string">"Nb people infected at init"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: nb_infected_init min: <span class="hljs-number"><span class="hljs-number">1</span></span> max: <span class="hljs-number"><span class="hljs-number">2147</span></span>;

    output {
        monitor <span class="hljs-string"><span class="hljs-string">"Infected people rate"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: infected_rate;
        
        display map {
            species road aspect:geom;
            species building aspect:geom;
            species people aspect:circle;           
        }
        
        display chart_display refresh: every(<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-meta"><span class="hljs-meta">#cycle) {</span></span>
            chart <span class="hljs-string"><span class="hljs-string">"Disease spreading"</span></span> type: series {
                data <span class="hljs-string"><span class="hljs-string">"susceptible"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_not_infected color: <span class="hljs-meta"><span class="hljs-meta">#green;</span></span>
                data <span class="hljs-string"><span class="hljs-string">"infected"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_infected color: <span class="hljs-meta"><span class="hljs-meta">#red;</span></span>
            }
        }
    }
}
</code></pre>
<p><a href="LuneraysFlu_step5.html">Next step: Definition of 3D displays</a></p>
<script>hljs.initHighlightingOnLoad();</script></body></html>