<html><!-- Online page at https://github.com/gama-platform/gama/wiki/Tutorials/Tutorials/IncrementalModel/IncrementalModel_step2 --><head><meta charset="utf-8"><title>IncrementalModel_step2</title><script src="../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="incrementalmodel_step2">IncrementalModel_step2</h1>
<a class="dashAnchor" name="//apple_ref/Section/2.%20Charts"></a><h1 id="2-charts">2. Charts</h1>
<p>This step Illustrates how define monitors and charts in GAMA. In addition, it illustrates how to define a stopping condition for the simulation.</p>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Formulation"></a><h2 id="formulation">Formulation</h2>
<ul>
<li>Definition of new global variables: current_hour, nb_people_infected, nb_people_not_infected, infected_rate
<ul>
<li>Definition of a monitor to follow the current hour and the nb of people infected</li>
<li>Definition of a series chart to follow the number of people infected and not infected</li>
<li>Definition of a stopping condition (when infected rate = 1)</li>
</ul>
</li>
</ul>
<p><img src="../../../../github.com/wiki/gama-platform/gama/Tutorials/Tutorials/IncrementalModel/resources/images/tutorials/Incremental_model2.jpg" alt="images/Incremental_model2.jpg"></p>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Model%20Definition"></a><h2 id="model-definition">Model Definition</h2>
<a class="dashAnchor" name="//apple_ref/Section/global%20variables"></a><h3 id="global-variables">global variables</h3>
<p>In order to define dynamic variable able to update itself, we use the <strong>update</strong> facet of variable definition.
Indeed, at each simulation step, all the agents (and the world agent) apply for each dynamic variable (in their definition order) its update expression.
We define 4 new variables:</p>
<ul>
<li><strong>current hour</strong> (int) : current simulation step (<strong>cycle</strong>) / 60 mod 24
<ul>
<li><strong>nb_people_infected</strong> (int): nb of people with is_infected = true (use of the <strong>list count condition</strong> operator that count the number of elements of the list for which the condition is true)</li>
<li><strong>nb_people_not_infected</strong> (int): nb_people - nb of people infected</li>
<li><strong>infected_rate</strong> (float): nb of people infected / nb of people
<code>
global{
    ...
        int current_hour update: (cycle / 60) mod 24;
    int nb_people_infected &lt;- nb_infected_init update: people count (each.is_infected);
    int nb_people_not_infected &lt;- nb_people - nb_infected_init update: nb_people - nb_people_infected;
    float infected_rate update: nb_people_infected/nb_people;
    ...
}
</code>
### stopping condition</li>
</ul>
</li>
</ul>
<p>We add a new reflex that stops the simulation if the <strong>infected_rate</strong> is equal to 1. To stop the simulation, we apply the <strong>halt</strong> action.</p>
<pre><code class="hljs less"><span class="hljs-selector-tag"><span class="hljs-selector-tag">global</span></span> {
   ...
        <span class="hljs-selector-tag"><span class="hljs-selector-tag">reflex</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">end_simulation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: infected_rate = <span class="hljs-number"><span class="hljs-number">1.0</span></span> {
        do halt;
    }
}
</code></pre>
<p>Note that it would have been possible to use the <strong>pause</strong> action that pauses the simulation instead of the <strong>halt</strong> action that stops the simulation.</p>
<a class="dashAnchor" name="//apple_ref/Section/monitor"></a><h3 id="monitor">monitor</h3>
<p>A monitor allows to follow the value of an arbitrary expression in GAML. It has to be defined in an output section. A monitor is defined as follows:</p>
<pre><code class="hljs smali">     <span class="hljs-built_in"><span class="hljs-built_in"> monitor </span></span>monitor_name value: an_expression refresh:every(nb_steps);
</code></pre>
<p>With:</p>
<ul>
<li>value: mandatory, its value will be displayed in the monitor.
<ul>
<li>refresh: bool, optional : if the expression is true, compute (default is true).</li>
</ul>
</li>
</ul>
<p>In this model, we define 2 monitors to follow the value of the variable <strong>current_hour</strong> and <strong>infected_rate</strong>:</p>
<pre><code class="hljs smali">experiment main_experiment type:gui{
<span class="hljs-keyword"><span class="hljs-keyword">    .</span></span>..
    output {
       <span class="hljs-built_in"><span class="hljs-built_in"> monitor </span></span><span class="hljs-string"><span class="hljs-string">"Current hour"</span></span> value: current_hour;
       <span class="hljs-built_in"><span class="hljs-built_in"> monitor </span></span><span class="hljs-string"><span class="hljs-string">"Infected people rate"</span></span> value: infected_rate;
<span class="hljs-keyword"><span class="hljs-keyword">        .</span></span>..
    }
}
</code></pre>
<a class="dashAnchor" name="//apple_ref/Section/chart"></a><h3 id="chart">chart</h3>
<p>GAMA can display various chart types:</p>
<ul>
<li>Time series
<ul>
<li>Pie charts</li>
<li>Histograms</li>
</ul>
</li>
</ul>
<p>A chart must be defined in a display : it behaves exactly like any other layer.
Definition of a chart :</p>
<pre><code class="hljs elm"><span class="hljs-title"><span class="hljs-title">chart</span></span> chart_name <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: chart_type  {
     [data]
}
</code></pre>
<p>The data to draw are define inside the chart block:</p>
<pre><code class="hljs irpf90">â€¨    <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> data_legend <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: data_value
</code></pre>
<p>We add a new display called <strong>chart</strong> refresh every 10 simulation steps.
Inside this display, we define a chart of type <em>series</em>:</p>
<ul>
<li>"Species evolution"; background : white; size : {1, 0.5}; position : {0, 0}
<ul>
<li>data1: susceptible; color : green</li>
<li>data2: infected; color : red</li>
</ul>
</li>
</ul>
<pre><code class="hljs lasso">experiment main_experiment <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>:gui{
    <span class="hljs-attr"><span class="hljs-attr">...</span></span>
    output {
        <span class="hljs-attr"><span class="hljs-attr">...</span></span>
        display chart refresh:every(<span class="hljs-number"><span class="hljs-number">10</span></span>) {
            chart <span class="hljs-string"><span class="hljs-string">"Disease spreading"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: series {
                <span class="hljs-built_in"><span class="hljs-built_in">data</span></span> <span class="hljs-string"><span class="hljs-string">"susceptible"</span></span> value: nb_people_not_infected color: #green;
                <span class="hljs-built_in"><span class="hljs-built_in">data</span></span> <span class="hljs-string"><span class="hljs-string">"infected"</span></span> value: nb_people_infected color: #red;
            }
        }
    }
}
</code></pre>
<table><thead><tr></tr></thead><tbody><tr></tr><tr></tr></tbody></table><a class="dashAnchor" name="//apple_ref/Section/Complete%20Model"></a><h2 id="complete-model">Complete Model</h2>
<pre><code class="hljs cs">model SI_city

global{
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people &lt;- <span class="hljs-number"><span class="hljs-number">500</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> step &lt;- <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-meta"><span class="hljs-meta">#minutes;</span></span>
    geometry shape&lt;-envelope(square(<span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-meta"><span class="hljs-meta">#m));</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infection_distance &lt;- <span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-meta"><span class="hljs-meta">#m;</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> proba_infection &lt;- <span class="hljs-number"><span class="hljs-number">0.05</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_infected_init &lt;- <span class="hljs-number"><span class="hljs-number">5</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> current_hour update: (cycle / <span class="hljs-number"><span class="hljs-number">60</span></span>) mod <span class="hljs-number"><span class="hljs-number">24</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_infected &lt;- nb_infected_init update: <span class="hljs-function"><span class="hljs-function">people </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each.is_infected</span></span></span><span class="hljs-function">)</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nb_people_not_infected &lt;- nb_people - nb_infected_init update: nb_people - nb_people_infected;
    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> infected_rate update: nb_people_infected/length(people);
    
    init{
        create people number:nb_people {
            speed &lt;- <span class="hljs-number"><span class="hljs-number">5.0</span></span> <span class="hljs-meta"><span class="hljs-meta">#km/#h;</span></span>
        }
        ask nb_infected_init among people {
            is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
        }
    }
    reflex end_simulation <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: infected_rate = <span class="hljs-number"><span class="hljs-number">1.0</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> halt;
    }
}

species people skills:[moving]{     
    <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">false</span></span>;
    reflex move{
        <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> wander;
    }
    reflex infect <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: is_infected{
        ask people at_distance infection_distance {
            <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flip</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proba_infection</span></span></span><span class="hljs-function">) </span></span>{
                is_infected &lt;- <span class="hljs-literal"><span class="hljs-literal">true</span></span>;
            }
        }
    }
    aspect circle{
        <span class="hljs-function"><span class="hljs-function">draw </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">circle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span></span><span class="hljs-function">) color:is_infected ? #red : #green</span></span>;
    }
}

experiment main_experiment type:gui{
    parameter <span class="hljs-string"><span class="hljs-string">"Infection distance"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: infection_distance;
    parameter <span class="hljs-string"><span class="hljs-string">"Proba infection"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: proba_infection min: <span class="hljs-number"><span class="hljs-number">0.0</span></span> max: <span class="hljs-number"><span class="hljs-number">1.0</span></span>;
    parameter <span class="hljs-string"><span class="hljs-string">"Nb people infected at init"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>: nb_infected_init ;
    output {
        monitor <span class="hljs-string"><span class="hljs-string">"Current hour"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: current_hour;
        monitor <span class="hljs-string"><span class="hljs-string">"Infected people rate"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: infected_rate;
        display map {
            species people aspect:circle;           
        }
        display chart refresh:every(<span class="hljs-number"><span class="hljs-number">10</span></span>) {
            chart <span class="hljs-string"><span class="hljs-string">"Disease spreading"</span></span> type: series {
                data <span class="hljs-string"><span class="hljs-string">"susceptible"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_not_infected color: <span class="hljs-meta"><span class="hljs-meta">#green;</span></span>
                data <span class="hljs-string"><span class="hljs-string">"infected"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: nb_people_infected color: <span class="hljs-meta"><span class="hljs-meta">#red;</span></span>
            }
        }
    }
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>