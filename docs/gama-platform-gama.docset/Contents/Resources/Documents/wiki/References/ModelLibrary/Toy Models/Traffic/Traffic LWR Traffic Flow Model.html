<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Traffic/Traffic LWR Traffic Flow Model --><head><meta charset="utf-8"><title>Traffic LWR Traffic Flow Model</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="traffic-lwr-traffic-flow-model">Traffic LWR Traffic Flow Model</h1>
<h1 id="trafic-group-r2d2-maps7---lwr-model">Trafic Group (R2D2) MAPS7 - LWR Model</h1>
<p><em>Author : A. Banos, N. Corson, C. Pivano, L. Rajaonarivo, P. Taillandier</em></p>
<p>The LWR model was proposed by Lighthill and Whitham (1955) and by Richards (1956). It describes the trafic at a global level considering the speed, concentration and flows without taking into account the individual behavior af vehicles. Speed, concentration and flow are the three components of the LWR model. This models reproduces flow of traffic and congestion in specific conditions (homogeneous traffic), going from one equilibrium state to another (see the fundamental diagramm of traffic, which gives flow according to concentration).
In this model, a road is divided into sections and we arbitrarily give to the middle section a lower speed and critical concentration.</p>
<p>Code of the model : </p>
<pre><code class="hljs http">

<span class="processing">model TraficGroup

global {
        
    <span class="hljs-built_in">float</span> road_size &lt;- <span class="hljs-number">10</span> #km ;                         <span class="hljs-comment">// Size of the road</span>
    
    geometry <span class="hljs-built_in">shape</span> &lt;- rectangle (road_size, <span class="hljs-number">200</span> #m) ;   <span class="hljs-comment">// The world is a rectangle with a length equals to the size of the road and a height of 200m</span>
        
    <span class="hljs-built_in">float</span> time_step &lt;- <span class="hljs-number">1.0</span> ;                            <span class="hljs-comment">// Time step </span>
    <span class="hljs-built_in">int</span> nb_sections &lt;- <span class="hljs-number">10</span> ;                             <span class="hljs-comment">// Number of sections of the road</span>
    <span class="hljs-built_in">float</span> section_size &lt;- road_size / nb_sections ;     <span class="hljs-comment">// Size of a section</span>
    
    <span class="hljs-built_in">float</span> car_size &lt;- <span class="hljs-number">4</span> #m ;                                    <span class="hljs-comment">// Size of a car</span>
    <span class="hljs-built_in">float</span> nb_max_cars_on_section &lt;- section_size / car_size ;   <span class="hljs-comment">// Maximum number of cars on one section </span>
    
       init{
            
            <span class="hljs-comment">// Creation of the nb_sections sections which compose the road. </span>
            
           <span class="hljs-built_in">loop</span> i from: <span class="hljs-number">0</span> to: (nb_sections - <span class="hljs-number">1</span>){
              create section with: [<span class="hljs-built_in">shape</span>:: <span class="hljs-built_in">line</span>([{i * section_size , <span class="hljs-number">100</span>},{(i +<span class="hljs-number">1</span>) * section_size , <span class="hljs-number">100</span>}])];
           }
            
            <span class="hljs-comment">// For each section, as we need to have information concerning the previous and the next one, we define which section is the previous and which is the next.</span>
            <span class="hljs-comment">// The previous section is the one which last point corresponds to the first point of the actual section. </span>
            <span class="hljs-comment">// The next section is the one which first point corresponds to the last point of the actual section. </span>
            
            ask section{
                previous &lt;- section first_with (last(each.<span class="hljs-built_in">shape</span>.points) = first(self.<span class="hljs-built_in">shape</span>.points)) ;
                next &lt;- section first_with (first(each.<span class="hljs-built_in">shape</span>.points) = last(self.<span class="hljs-built_in">shape</span>.points)) ;
            }
    
            <span class="hljs-comment">// For each section, we define a critical concentration (see the fundamental diagram), a maximum speed, a concentration and a flow (which are = 0 at initialization). </span>
            <span class="hljs-comment">// A fundamental relation about trafic gives : flow = concentration * speed.</span>
            
            ask section{
                critical_concentration &lt;- <span class="hljs-number">125.0</span> ; <span class="hljs-comment">//Kc</span>
                max_speed &lt;- <span class="hljs-number">50</span> #km/#h; <span class="hljs-comment">// Vl</span>
                current_concentration &lt;- <span class="hljs-number">0.0</span> ;
                current_flow &lt;- current_concentration * max_speed ;
                max_flow &lt;- critical_concentration * max_speed ; 
            }
                        
            <span class="hljs-comment">// The concentration and flow ot first section are initialized.</span>
            
            ask section[<span class="hljs-number">0</span>]{
                current_concentration &lt;- nb_max_cars_on_section ;
                current_flow &lt;- current_concentration * max_speed ;
            }
            
            <span class="hljs-comment">// The middle section is supposed to have a different maximum speed and a different critical concentration so that we can observe congestion phenomenon.</span>
            <span class="hljs-comment">// This middle section is green.</span>
            
            ask section[<span class="hljs-built_in">int</span>(nb_sections/<span class="hljs-number">2</span>)] {
                    critical_concentration &lt;- <span class="hljs-number">10.0</span> ; 
                    max_flow &lt;- critical_concentration * max_speed ; 
                    max_speed &lt;- <span class="hljs-number">10</span> #km/#h; 
                    <span class="hljs-built_in">color</span> &lt;- #<span class="hljs-built_in">green</span>;
            }
        }
        
   <span class="hljs-comment">// To update flow and concentration at each time step in each section, we use an offer and a demand function. </span>
   <span class="hljs-comment">// These functions define the welcome capacity (offer) and the emission capacity (demand) of a section.</span>
   
    reflex offer_function {
         ask section {
              <span class="hljs-keyword">if</span> current_concentration &lt;= critical_concentration {
                offer &lt;- max_flow ;
              }
              <span class="hljs-keyword">else</span> {
                offer &lt;- <span class="hljs-built_in">max</span>([<span class="hljs-number">0</span> , (- max_flow / critical_concentration) * current_concentration + <span class="hljs-number">2</span> * max_flow ]);
              }
          
      }
    }
    
    reflex demand_function {
        ask section{
              <span class="hljs-keyword">if</span> current_concentration &lt;= critical_concentration {
                    demand &lt;- <span class="hljs-built_in">max</span>([<span class="hljs-number">0</span> , ( max_flow / critical_concentration) * current_concentration]) ;
              }
              <span class="hljs-keyword">else</span> {
                    demand &lt;- max_flow ;
              }
        }
    }
    
    <span class="hljs-comment">// The flow and concentration are then updated according to the offer and demand functions of the current section, but also of the next and previous ones.</span>
    
    <span class="hljs-comment">// During a time step, the flow of a section take the minimum value between its demand and the offer of the next section.</span>
    <span class="hljs-comment">// The flow of the last section is equal to its demand. </span>
    
    reflex update_flow{
        ask section  {
            <span class="hljs-built_in">float</span> next_offer &lt;-  (self.next != nil) ? (self.next).offer : self.demand;
            current_flow &lt;- <span class="hljs-built_in">min</span>([self.demand, next_offer]);
        }
    }
    
    
    <span class="hljs-comment">// After a time step, the concentration is updated from the current concentration, according to the incoming and outgoing concentrations.</span>
    <span class="hljs-comment">// The first section concentration on ly takes into account the outgoing concentration of vehicles.</span>
    
    reflex update_concentration{
        ask section   {
            <span class="hljs-built_in">float</span> previous_flow &lt;- (self.previous != nil) ? (self.previous).current_flow : <span class="hljs-number">0.0</span>;
            current_concentration &lt;- current_concentration + time_step/section_size *(previous_flow - self.current_flow) ;
        }   
    }
    
    <span class="hljs-comment">// When there is less than one car left on the road, the simulation stops.</span>
    
    reflex stop_simulation when: sum(section collect each.current_concentration) &lt; <span class="hljs-number">1.0</span> {
        do pause;
    }
}

<span class="hljs-comment">// A road is divided into sections. </span>
<span class="hljs-comment">// Each section has a concentration, a flow, an offer and a demand, a critical concentration, a maximum speed and a maximum flow, </span>
<span class="hljs-comment">// and a previous and a next section.</span>

species section {
    <span class="hljs-built_in">float</span> current_concentration  ;
    <span class="hljs-built_in">float</span> current_flow  ;
    
    <span class="hljs-built_in">float</span> offer ;
    <span class="hljs-built_in">float</span> demand  ;
    
    rgb <span class="hljs-built_in">color</span>;
    
    <span class="hljs-built_in">float</span> critical_concentration ; 
    <span class="hljs-built_in">float</span> max_speed ; 
    <span class="hljs-built_in">float</span> max_flow ; 

    section previous ;
    section next ;
    
    <span class="hljs-comment">// The width of a section depends on its concentration.</span>
    
    aspect shape_section {
        <span class="hljs-title">draw</span> <span class="hljs-built_in">shape</span> + (<span class="hljs-number">1</span> + <span class="hljs-number">15</span> * ln (current_concentration + <span class="hljs-number">1</span>)) <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span>;        
    } 

}


experiment TraficGroup type: gui {

    <span class="hljs-comment">// Users can chose the number of sections and the time step.</span>

    parameter <span class="hljs-string">'Number of sections'</span> var: nb_sections category: <span class="hljs-string">"Section parameter"</span>;
    parameter <span class="hljs-string">'Time step - DeltaT'</span> var: time_step category: <span class="hljs-string">"Time parameter"</span>;
        
    output {
        
        <span class="hljs-comment">// A monitor gives the number of cars on the road at every time step.</span>
        
        monitor <span class="hljs-string">"Sum Concentrations"</span> value: sum(section collect each.current_concentration);
        
        <span class="hljs-comment">// A display shows the road. Section width depend on their concentration.</span>
        
        display TheRoad{
            species section aspect: shape_section ;
        }
        
        <span class="hljs-comment">// The greeen time series correspond to the middle section (on which concentration and maximum speed are lower).</span>
        <span class="hljs-comment">// The red time series correspond to the section just before the middle one.</span>
                
        display Concentrations {
            chart <span class="hljs-string">"Concentrations"</span> type: series  {
                data <span class="hljs-string">'Section 0'</span> value: section[<span class="hljs-number">0</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span> ;               
                data <span class="hljs-string">'Section 1'</span> value: section[<span class="hljs-number">1</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 2'</span> value: section[<span class="hljs-number">2</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 3'</span> value: section[<span class="hljs-number">3</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;                
                data <span class="hljs-string">'Section 4'</span> value: section[<span class="hljs-built_in">int</span>(nb_sections/<span class="hljs-number">2</span> - <span class="hljs-number">1</span> ) ].current_concentration <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">red</span> marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 5'</span> value: section[<span class="hljs-built_in">int</span>(nb_sections/<span class="hljs-number">2</span>)].current_concentration <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">green</span> marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 6'</span> value: section[<span class="hljs-number">6</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;                
                data <span class="hljs-string">'Section 7'</span> value: section[<span class="hljs-number">7</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 8'</span> value: section[<span class="hljs-number">8</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 9'</span> value: section[<span class="hljs-number">9</span>].current_concentration <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                }
            }
            
            display Flows {
                chart <span class="hljs-string">"Flows"</span> type: series  {
                data <span class="hljs-string">'Section 0'</span> value: section[<span class="hljs-number">0</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;             
                data <span class="hljs-string">'Section 1'</span> value: section[<span class="hljs-number">1</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 2'</span> value: section[<span class="hljs-number">2</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 3'</span> value: section[<span class="hljs-number">3</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;             
                data <span class="hljs-string">'Section 4'</span> value: section[<span class="hljs-built_in">int</span>(nb_sections/<span class="hljs-number">2</span> - <span class="hljs-number">1</span>)].current_flow <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">red</span> marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 5'</span> value: section[<span class="hljs-built_in">int</span>(nb_sections/<span class="hljs-number">2</span>)].current_flow <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">green</span> marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 6'</span> value: section[<span class="hljs-number">6</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;             
                data <span class="hljs-string">'Section 7'</span> value: section[<span class="hljs-number">7</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 8'</span> value: section[<span class="hljs-number">8</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                data <span class="hljs-string">'Section 9'</span> value: section[<span class="hljs-number">9</span>].current_flow <span class="hljs-built_in">color</span>: #gray marker: <span class="hljs-keyword">false</span>;
                }
            }
    }
}
</span></code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>