<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Flood Simulation/Flood Simulation Hydrological Model --><head><meta charset="utf-8"><title>Flood Simulation Hydrological Model</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="flood-simulation-hydrological-model">Flood Simulation Hydrological Model</h1>
<h1 id="hydrological-model">Hydrological Model</h1>
<p><em>Author : Patrick Taillandier</em></p>
<p>A model showing how to represent a flooding system with dykes and buildings. It uses a grid to discretize space, and has a 3D display. The water can flow from one cell to another considering the height of the cells, and the water pressure. It is also possible to delete dyke by clicking on one of them in the display.</p>
<p>Code of the model : </p>
<pre><code class="hljs processing">
model hydro

global {
   <span class="hljs-comment">//Shapefile for the river</span>
   file river_shapefile &lt;- file(<span class="hljs-string">"../includes/RedRiver.shp"</span>);
   <span class="hljs-comment">//Shapefile for the dykes</span>
   file dykes_shapefile &lt;- file(<span class="hljs-string">"../includes/Dykes.shp"</span>);
   <span class="hljs-comment">//Shapefile for the buildings</span>
   file buildings_shapefile &lt;- file(<span class="hljs-string">"../includes/Building.shp"</span>);
   
   <span class="hljs-comment">//Data elevation file</span>
   file dem_file &lt;- file(<span class="hljs-string">"../includes/mnt50.asc"</span>);  
   <span class="hljs-comment">//Diffusion rate</span>
   <span class="hljs-built_in">float</span> diffusion_rate &lt;- <span class="hljs-number">0.6</span>;
   <span class="hljs-comment">//Height of the dykes</span>
   <span class="hljs-built_in">float</span> dyke_height &lt;- <span class="hljs-number">15.0</span>;
   <span class="hljs-comment">//Width of the dyke</span>
   <span class="hljs-built_in">float</span> dyke_width &lt;- <span class="hljs-number">15.0</span>;
    
   <span class="hljs-comment">//Shape of the environment using the dem file</span>
   geometry <span class="hljs-built_in">shape</span> &lt;- envelope(dem_file);
   
   <span class="hljs-comment">//List of the drain and river cells</span>
   list&lt;cell&gt; drain_cells;
   list&lt;cell&gt; river_cells;
   
   
  
   <span class="hljs-built_in">float</span> step &lt;- <span class="hljs-number">1</span>Â°h;
   
   init {
     <span class="hljs-comment">//Initialization of the cells</span>
      do init_cells;
     <span class="hljs-comment">//Initialization of the water cells</span>
      do init_water;
     <span class="hljs-comment">//Initialization of the river cells</span>
     river_cells &lt;- cell where (each.is_river);
     <span class="hljs-comment">//Initialization of the drain cells</span>
      drain_cells &lt;- cell where (each.is_drain);
     <span class="hljs-comment">//Initialization of the obstacles (buildings and dykes)</span>
      do init_obstacles;
      <span class="hljs-comment">//Set the height of each cell</span>
      ask cell {
         obstacle_height &lt;- compute_highest_obstacle();
         do update_color;
      }
   }
   <span class="hljs-comment">//Action to initialize the altitude value of the cell according to the dem file</span>
   action init_cells {
      ask cell {
         altitude &lt;- grid_value;
         neighbour_cells &lt;- (self neighbors_at <span class="hljs-number">1</span>) ;
      }
   }
   <span class="hljs-comment">//action to initialize the water cells according to the river shape file and the drain</span>
   action init_water {
      geometry river &lt;- geometry(river_shapefile);
      ask cell overlapping river {
         water_height &lt;- <span class="hljs-number">10.0</span>;
         is_river &lt;- <span class="hljs-keyword">true</span>;
         is_drain &lt;- grid_y = matrix(cell).rows - <span class="hljs-number">1</span>;
      }
   }
   <span class="hljs-comment">//initialization of the obstacles (the buildings and the dykes)</span>
   action init_obstacles{
      create buildings from: buildings_shapefile  {
         do update_cells;
      }
      create dyke from: dykes_shapefile;
      ask dyke {
          <span class="hljs-built_in">shape</span> &lt;-  <span class="hljs-built_in">shape</span> + dyke_width;
            do update_cells;
      }
   }
   <span class="hljs-comment">//Reflex to add water among the water cells</span>
   reflex adding_input_water {
      <span class="hljs-built_in">float</span> water_input &lt;- rnd(<span class="hljs-number">100</span>)/<span class="hljs-number">100</span>;
      ask river_cells {
         water_height &lt;- water_height + water_input;
      }
   }
   <span class="hljs-comment">//Reflex to flow the water according to the altitute and the obstacle</span>
   reflex flowing {
      ask cell {already &lt;- <span class="hljs-keyword">false</span>;}
      ask (cell sort_by ((each.altitude + each.water_height + each.obstacle_height))) {
         do flow;
      }
   }
   <span class="hljs-comment">//Reflex to update the color of the cell</span>
   reflex update_cell_color {
      ask cell {
         do update_color;
      }
   }
   <span class="hljs-comment">//Reflex for the drain cells to drain water</span>
   reflex draining {
      ask drain_cells {
         water_height &lt;- <span class="hljs-number">0.0</span>;
      }
   }
   
}
<span class="hljs-comment">//Species which represent the obstacle</span>
   species obstacle {
      <span class="hljs-comment">//height of the obstacle</span>
      <span class="hljs-built_in">float</span> <span class="hljs-built_in">height</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">0.0</span>;
      <span class="hljs-comment">//Color of the obstacle</span>
      rgb <span class="hljs-built_in">color</span>;
      <span class="hljs-comment">//Pressure of the water</span>
      <span class="hljs-built_in">float</span> water_pressure update: compute_water_pressure();
      
      <span class="hljs-comment">//List of cells concerned</span>
      list&lt;cell&gt; cells_concerned ;
      <span class="hljs-comment">//List of cells in the neighbourhood </span>
      list&lt;cell&gt; cells_neighbours;
      
      <span class="hljs-comment">//Action to compute the water pressure</span>
      <span class="hljs-built_in">float</span> compute_water_pressure {
        <span class="hljs-comment">//If the obstacle doesn't have height, then there will be no pressure</span>
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">height</span> = <span class="hljs-number">0.0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;
         } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//The leve of the water is equals to the maximul level of water in the neighbours cells</span>
            <span class="hljs-built_in">float</span> water_level &lt;- cells_neighbours max_of (each.water_height);
            <span class="hljs-comment">//Return the water pressure as the minimal value between 1 and the water level divided by the height</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>([<span class="hljs-number">1.0</span>,water_level / <span class="hljs-built_in">height</span>]);
         } 
      }
      
      <span class="hljs-comment">//Action to update the cells</span>
      action update_cells {
        <span class="hljs-comment">//All the cells concerned by the obstacle are the ones overlapping the obstacle</span>
         cells_concerned &lt;- (cell overlapping self);
            ask cells_concerned {
            <span class="hljs-comment">//Add the obstacles to the obstacles of the cell</span>
            <span class="hljs-built_in">add</span> myself to: obstacles;
            water_height &lt;- <span class="hljs-number">0.0</span>;
         }
         <span class="hljs-comment">//Cells neighbours are all the neighbours cells of the cells concerned</span>
         cells_neighbours &lt;- cells_concerned + cells_concerned accumulate (each.neighbour_cells);
         <span class="hljs-comment">//The height is now computed</span>
         do compute_height();
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">height</span> &gt; <span class="hljs-number">0.0</span>) {   
            <span class="hljs-comment">//We compute the water pressure again</span>
            water_pressure &lt;- compute_water_pressure();
         } <span class="hljs-keyword">else</span> {water_pressure &lt;- <span class="hljs-number">0.0</span>;}
      }
      action compute_height;
      aspect geometry {
         <span class="hljs-built_in">int</span> val &lt;- <span class="hljs-built_in">int</span>( <span class="hljs-number">255</span> * water_pressure);
         <span class="hljs-built_in">color</span> &lt;- rgb(val,<span class="hljs-number">255</span>-val,<span class="hljs-number">0</span>);
         <span class="hljs-title">draw</span> <span class="hljs-built_in">shape</span> <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span> depth: <span class="hljs-built_in">height</span>*<span class="hljs-number">5</span> border: <span class="hljs-built_in">color</span>;
      }
   }
   <span class="hljs-comment">//Species buildings which is derivated from obstacle</span>
   species buildings parent: obstacle {
     <span class="hljs-comment">//The building has a height randomly chosed between 2 and 10</span>
      <span class="hljs-built_in">float</span> <span class="hljs-built_in">height</span> &lt;- <span class="hljs-number">2.0</span> + rnd(<span class="hljs-number">8</span>);
   }
   <span class="hljs-comment">//Species dyke which is derivated from obstacle</span>
   species dyke parent: obstacle{
    
       <span class="hljs-built_in">int</span> counter_wp &lt;- <span class="hljs-number">0</span>;
       <span class="hljs-built_in">int</span> breaking_threshold &lt;- <span class="hljs-number">24</span>;
      
      <span class="hljs-comment">//Action to represent the break of the dyke</span>
       action <span class="hljs-keyword">break</span>{
         ask cells_concerned {
            do update_after_destruction(myself);
         }
         do die;
      }
      <span class="hljs-comment">//Action to compute the height of the dyke as the dyke_height without the mean height of the cells it overlaps</span>
      action compute_height
       {
           <span class="hljs-built_in">height</span> &lt;- dyke_height - mean(cells_concerned collect (each.altitude));
      
      }
      
      <span class="hljs-comment">//Reflex to break the dynamic of the water</span>
      reflex breaking_dynamic {
        <span class="hljs-keyword">if</span> (water_pressure = <span class="hljs-number">1.0</span>) {
            counter_wp &lt;- counter_wp + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (counter_wp &gt; breaking_threshold) {
                do <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">else</span> {
            counter_wp &lt;- <span class="hljs-number">0</span>;
        }
      }
      <span class="hljs-comment">//user command which allows the possibility to destroy the dyke for the user</span>
      user_command <span class="hljs-string">"Destroy dyke"</span> action: <span class="hljs-keyword">break</span>; 
   }
   <span class="hljs-comment">//Grid cell to discretize space, initialized using the dem file</span>
   grid cell file: dem_file neighbors: <span class="hljs-number">8</span> frequency: <span class="hljs-number">0</span>  use_regular_agents: <span class="hljs-keyword">false</span> use_individual_shapes: <span class="hljs-keyword">false</span> use_neighbors_cache: <span class="hljs-keyword">false</span> {
      <span class="hljs-comment">//Altitude of the cell</span>
      <span class="hljs-built_in">float</span> altitude;
      <span class="hljs-comment">//Height of the water in the cell</span>
      <span class="hljs-built_in">float</span> water_height &lt;- <span class="hljs-number">0.0</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">0.0</span>;
      <span class="hljs-comment">//Height of the cell</span>
      <span class="hljs-built_in">float</span> <span class="hljs-built_in">height</span>;
      <span class="hljs-comment">//List of the neighbour cells</span>
      list&lt;cell&gt; neighbour_cells ;
      <span class="hljs-comment">//Boolean to know if it is a drain cell</span>
      bool is_drain &lt;- <span class="hljs-keyword">false</span>;
      <span class="hljs-comment">//Boolean to know if it is a river cell</span>
      bool is_river &lt;- <span class="hljs-keyword">false</span>;
      <span class="hljs-comment">//List of all the obstacles overlapping the cell</span>
      list&lt;obstacle&gt; obstacles;
      <span class="hljs-comment">//Height of the obstacles</span>
      <span class="hljs-built_in">float</span> obstacle_height &lt;- <span class="hljs-number">0.0</span>;
      bool already &lt;- <span class="hljs-keyword">false</span>;
      
      <span class="hljs-comment">//Action to compute the highest obstacle among the obstacles</span>
      <span class="hljs-built_in">float</span> compute_highest_obstacle {
         <span class="hljs-keyword">if</span> (empty(obstacles))
         {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>; 
         } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> obstacles max_of(each.<span class="hljs-built_in">height</span>);
         }
      }
      <span class="hljs-comment">//Action to flow the water </span>
      action flow {
        <span class="hljs-comment">//if the height of the water is higher than 0 then, it can flow among the neighbour cells</span>
         <span class="hljs-keyword">if</span> (water_height &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">//We get all the cells already done</span>
            list&lt;cell&gt; neighbour_cells_al &lt;- neighbour_cells where (each.already);
            <span class="hljs-comment">//If there are cells already done then we continue</span>
            <span class="hljs-keyword">if</span> (!empty(neighbour_cells_al)) {
               <span class="hljs-comment">//We compute the height of the neighbours cells according to their altitude, water_height and obstacle_height</span>
               ask neighbour_cells_al {<span class="hljs-built_in">height</span> &lt;- altitude + water_height + obstacle_height;}
               <span class="hljs-comment">//The height of the cell is equals to its altitude and water height</span>
               <span class="hljs-built_in">height</span> &lt;-  altitude +  water_height;
               <span class="hljs-comment">//The water of the cells will flow to the neighbour cells which have a height less than the height of the actual cell</span>
               list&lt;cell&gt; flow_cells &lt;- (neighbour_cells_al where (<span class="hljs-built_in">height</span> &gt; each.<span class="hljs-built_in">height</span>)) ;
               <span class="hljs-comment">//If there are cells, we compute the water flowing</span>
               <span class="hljs-keyword">if</span> (!empty(flow_cells)) {
                  <span class="hljs-built_in">loop</span> flow_cell over: shuffle(flow_cells) sort_by (each.<span class="hljs-built_in">height</span>){
                     <span class="hljs-built_in">float</span> water_flowing &lt;- <span class="hljs-built_in">max</span>([<span class="hljs-number">0.0</span>, <span class="hljs-built_in">min</span>([(<span class="hljs-built_in">height</span> - flow_cell.<span class="hljs-built_in">height</span>), water_height * diffusion_rate])]); 
                     water_height &lt;- water_height - water_flowing;
                     flow_cell.water_height &lt;-flow_cell.water_height +  water_flowing;
                     <span class="hljs-built_in">height</span> &lt;- altitude + water_height;
                  }   
               }
            }
         }
         already &lt;- <span class="hljs-keyword">true</span>;
      }  
      <span class="hljs-comment">//Update the color of the cell</span>
      action update_color { 
         <span class="hljs-built_in">int</span> val_water &lt;- <span class="hljs-number">0</span>;
         val_water &lt;- <span class="hljs-built_in">max</span>([<span class="hljs-number">0</span>, <span class="hljs-built_in">min</span>([<span class="hljs-number">255</span>, <span class="hljs-built_in">int</span>(<span class="hljs-number">255</span> * (<span class="hljs-number">1</span> - (water_height / <span class="hljs-number">12.0</span>)))])]) ;  
         <span class="hljs-built_in">color</span> &lt;- rgb([val_water, val_water, <span class="hljs-number">255</span>]);
         grid_value &lt;- water_height + altitude;
      }
      <span class="hljs-comment">//action to compute the destruction of the obstacle</span>
      action update_after_destruction(obstacle the_obstacle){
         remove the_obstacle from: obstacles;
         obstacle_height &lt;- compute_highest_obstacle();
      }
       
   }


experiment main_gui type: gui {
   parameter <span class="hljs-string">"Shapefile for the river"</span> var:river_shapefile category:<span class="hljs-string">"Water data"</span>;
   parameter <span class="hljs-string">"Shapefile for the dykes"</span> var:dykes_shapefile category:<span class="hljs-string">"Obstacles"</span>;
   parameter <span class="hljs-string">"Shapefile for the buildings"</span> var:buildings_shapefile category:<span class="hljs-string">"Obstacles"</span>;
   parameter <span class="hljs-string">"Height of the dykes"</span> var:dyke_height category:<span class="hljs-string">"Obstacles"</span>;
   parameter <span class="hljs-string">"Diffusion rate"</span> var:diffusion_rate category:<span class="hljs-string">"Water dynamic"</span>;
   output { 
      display <span class="hljs-built_in">map</span> type: opengl {
         grid cell triangulation: <span class="hljs-keyword">true</span>;
         species buildings aspect: geometry;
         species dyke aspect: geometry ;
      }
      display chart_display refresh: every(<span class="hljs-number">24</span>) { 
         chart <span class="hljs-string">"Pressure on Dykes"</span> type: series {
            data <span class="hljs-string">"Mean pressure on dykes "</span> value: mean(dyke collect (each.water_pressure)) style: <span class="hljs-built_in">line</span> <span class="hljs-built_in">color</span>: #magenta ;
            data <span class="hljs-string">"Rate of dykes with max pressure"</span> value: (dyke count (each.water_pressure = <span class="hljs-number">1.0</span>))/ length(dyke) style: <span class="hljs-built_in">line</span> <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">red</span> ;
            data <span class="hljs-string">"Rate of dykes with high pressure"</span> value: (dyke count (each.water_pressure &gt; <span class="hljs-number">0.5</span>))/ length(dyke) style: <span class="hljs-built_in">line</span> <span class="hljs-built_in">color</span>: #orange ;
            data <span class="hljs-string">"Rate of dykes with low pressure"</span> value: (dyke count (each.water_pressure &lt; <span class="hljs-number">0.25</span>))/ length(dyke) style: <span class="hljs-built_in">line</span> <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">green</span> ;
         }
      }
   }
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>