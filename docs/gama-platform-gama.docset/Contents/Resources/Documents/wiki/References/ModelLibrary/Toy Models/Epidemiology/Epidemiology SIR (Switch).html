<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Epidemiology/Epidemiology SIR (Switch) --><head><meta charset="utf-8"><title>Epidemiology SIR (Switch)</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="epidemiology-sir-switch">Epidemiology SIR (Switch)</h1>
<h1 id="sir_switch">SIR_switch</h1>
<p>_Author : tri and hqnghi _</p>
<p>A model which show how to implement ODE system, IBM model, and to switch from one to another using a threshold. Another interesting point seen in this model is the the minimization of the execution time by reducing the number of agents to compute infections.</p>
<p>Code of the model : </p>
<pre><code class="hljs zephir">model SIR_switch

<span class="hljs-keyword">global</span> {
    <span class="hljs-comment">// Parameters</span>
    <span class="hljs-keyword">int</span> initial_S &lt;- <span class="hljs-number">495</span> ; <span class="hljs-comment">// The number of susceptible</span>
    <span class="hljs-keyword">int</span> initial_I &lt;- <span class="hljs-number">5</span>   ; <span class="hljs-comment">// The number of infected</span>
    <span class="hljs-keyword">int</span> initial_R &lt;- <span class="hljs-number">0</span>   ; <span class="hljs-comment">// The number of removed </span>

    <span class="hljs-keyword">float</span> beta &lt;- <span class="hljs-number">0.1</span>   ; <span class="hljs-comment">// The parameter Beta </span>
    <span class="hljs-keyword">float</span> delta &lt;- <span class="hljs-number">0.01</span> ; <span class="hljs-comment">// The parameter Delta    </span>
    
    <span class="hljs-keyword">int</span> switch_threshold &lt;- <span class="hljs-number">120</span> ; <span class="hljs-comment">// threshold for switching models</span>
    <span class="hljs-keyword">bool</span> local_infection &lt;- <span class="hljs-keyword">true</span> ;
    <span class="hljs-keyword">int</span> neighbours_range &lt;- <span class="hljs-number">2</span> ;
    <span class="hljs-keyword">bool</span> local_random_walk &lt;- <span class="hljs-keyword">true</span> ; 
    
    
    <span class="hljs-comment">// Global variables</span>
    <span class="hljs-keyword">int</span> grid_size &lt;- <span class="hljs-number">50</span>;
geometry shape &lt;- square(grid_size);
    <span class="hljs-keyword">int</span> number_Hosts &lt;- initial_S + initial_I + initial_R; <span class="hljs-comment">// Total number of individuals</span>
    SIR_model current_model; <span class="hljs-comment">// serves as an interface, it is transparent to user if model is maths or IBM</span>

    <span class="hljs-keyword">float</span> beta_maths;
    <span class="hljs-keyword">int</span> gridSize &lt;- <span class="hljs-number">1</span>; <span class="hljs-comment">//size of the grid</span>
    <span class="hljs-keyword">float</span> neighbourhoodSize &lt;- <span class="hljs-number">1.0</span>; <span class="hljs-comment">// average size of the neighbourhood (in number of cells)   </span>
    <span class="hljs-keyword">float</span> adjust &lt;- <span class="hljs-number">0.721</span>; <span class="hljs-comment">// to adjust math model to ABM when using random walk</span>
    <span class="hljs-keyword">bool</span> computeInfectionFromS &lt;- initial_S &lt; initial_I; <span class="hljs-comment">// if true, use the S list to compute infections. If false, use I list.</span>
    <span class="hljs-comment">// the purpose is to minimize the number of evaluation by using the smallest list.</span>
    
    init {
        create new_scheduler;
        <span class="hljs-comment">/* determine the size of the neighbourhood and the average count of hosts neighbours */</span>
        gridSize &lt;- length(sir_grid);
        <span class="hljs-keyword">int</span> nbCells &lt;- <span class="hljs-number">0</span>;
        
        loop cell over: sir_grid {
            nbCells &lt;- nbCells + length(cell.neighbours);
        }

        neighbourhoodSize &lt;- nbCells / gridSize + <span class="hljs-number">1</span>; <span class="hljs-comment">// +1 to count itself in the neighbourhood;</span>
        beta_maths &lt;- beta * neighbourhoodSize * number_Hosts / gridSize * adjust;
        
        write <span class="hljs-string">'Switch will happen at population sizes around '</span> +switch_threshold;
        write <span class="hljs-string">'Basic Reproduction Number (R0): '</span> + string(beta / delta) + <span class="hljs-string">'\n'</span>;
        
        <span class="hljs-comment">//Creation of the switch_model agent that will manage the switch between the mathematical and the individual based models</span>
        create switch_model {
            threshold_to_IBM &lt;- switch_threshold;
            threshold_to_Maths &lt;- switch_threshold;
        }
        <span class="hljs-comment">//Creation of the model according to the one to begin with</span>
        <span class="hljs-keyword">if</span> (first(switch_model).start_with_IBM) {
        <span class="hljs-comment">//      write 'Starting with IBM model';</span>
            create IBM_model;
            current_model &lt;- first(IBM_model);
        } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">//      write 'Starting with Maths model';</span>
            create Math_model;
            current_model &lt;- first(Math_model);
        }
        <span class="hljs-comment">//Initialization of the Susceptible, Infected, Resistant and Total Compartiment</span>
        current_model.S &lt;- <span class="hljs-keyword">float</span>(initial_S);
        current_model.I &lt;- <span class="hljs-keyword">float</span>(initial_I);
        current_model.R &lt;- <span class="hljs-keyword">float</span>(initial_R);
        current_model.N &lt;- number_Hosts;
        
        <span class="hljs-comment">//Ask to the model to initialize itself according to the value initialized</span>
        ask current_model {
            <span class="hljs-keyword">do</span> initialize;
        }
        
        <span class="hljs-comment">//Create the SIR maths with ODE to compare</span>
        create my_SIR_maths {
            <span class="hljs-keyword">self</span>.S &lt;- <span class="hljs-keyword">float</span>(myself.initial_S);
            <span class="hljs-keyword">self</span>.I &lt;- <span class="hljs-keyword">float</span>(myself.initial_I);
            <span class="hljs-keyword">self</span>.R &lt;- <span class="hljs-keyword">float</span>(myself.initial_R);
            <span class="hljs-keyword">self</span>.N &lt;- number_Hosts;
            <span class="hljs-keyword">self</span>.beta1 &lt;- beta * neighbourhoodSize * (N / gridSize)* adjust;
            <span class="hljs-keyword">self</span>.alpha &lt;- delta;
        }

    }

    reflex infection_computation_method {
    <span class="hljs-comment">/* computing infection from S has a complexity of S*ngb, where ngb is the size of the neighbourhood.
     * computing infection from I has a complexity of I*ngb.
     * this reflex determine which method has the lowest cost.
     * */</span>
        computeInfectionFromS &lt;- (Host count (each.is_susceptible)) &lt; (Host count (each.is_infected));
    }

}
<span class="hljs-comment">//Grid which represent the discretized space for the host agents</span>
    grid sir_grid width: grid_size height: grid_size {
        rgb color &lt;- <span class="hljs-comment">#black;</span>
        <span class="hljs-keyword">list</span>&lt;sir_grid&gt; neighbours &lt;- (<span class="hljs-keyword">self</span> neighbors_at neighbours_range) of_species sir_grid;
    }


<span class="hljs-comment">//Species which allows the execution of only Host, IBM_model, Math_model and switch_model at each cycle</span>
species new_scheduler schedules: (Host + IBM_model + Math_model + switch_model) ;

<span class="hljs-comment">//Species which represent the manager between IBM and Math model</span>
species switch_model schedules: [] {
    <span class="hljs-keyword">int</span> threshold_to_IBM &lt;- <span class="hljs-number">45</span>; <span class="hljs-comment">// threshold under which the model swith to IBM</span>
    <span class="hljs-keyword">int</span> threshold_to_Maths &lt;- <span class="hljs-number">50</span>; <span class="hljs-comment">// threshold under which the model swith to Maths model </span>
    <span class="hljs-keyword">bool</span> start_with_IBM <span class="hljs-function"><span class="hljs-keyword">function</span>: </span>{ (initial_S &lt; threshold_to_IBM <span class="hljs-keyword">or</span> initial_I &lt; threshold_to_IBM) };

    <span class="hljs-comment">//Switch the model used to IBM when the threshold is higher than the population</span>
    reflex switch_to_IBM when: (current_model.model_type = <span class="hljs-string">'Maths'</span>) {
        <span class="hljs-keyword">if</span> (current_model.S &lt; threshold_to_IBM <span class="hljs-keyword">or</span> current_model.I &lt; threshold_to_IBM) {
            write <span class="hljs-string">'Switch to IBM model at cycle '</span> + string(cycle);
            create IBM_model {
                <span class="hljs-keyword">self</span>.S &lt;- current_model.S;
                <span class="hljs-keyword">self</span>.I &lt;- current_model.I;
                <span class="hljs-keyword">self</span>.R &lt;- current_model.R;
                <span class="hljs-keyword">self</span>.N &lt;- current_model.N;
                <span class="hljs-keyword">do</span> initialize;
            }

            ask current_model {
                <span class="hljs-keyword">do</span> remove_model;
            }

            current_model &lt;- first(IBM_model);
        }

    }
    <span class="hljs-comment">//Switch the model used to Maths when the threshold is lower than the population</span>
    reflex switch_to_Maths when: (current_model.model_type = <span class="hljs-string">'IBM'</span>) {
        <span class="hljs-keyword">if</span> (current_model.S &gt; threshold_to_Maths <span class="hljs-keyword">and</span> current_model.I &gt; threshold_to_Maths) {
            write <span class="hljs-string">'Switch to Maths model at cycle '</span> + cycle;
            create Math_model {
                <span class="hljs-keyword">self</span>.S &lt;- current_model.S;
                <span class="hljs-keyword">self</span>.I &lt;- current_model.I;
                <span class="hljs-keyword">self</span>.R &lt;- current_model.R;
                <span class="hljs-keyword">self</span>.N &lt;- current_model.N;
                <span class="hljs-keyword">do</span> initialize;
            }

            ask current_model {
                <span class="hljs-keyword">do</span> remove_model;
            }

            current_model &lt;- first(Math_model);
        }

    }

}
<span class="hljs-comment">//Species which represent the SIR model used by the IBM and the Math models </span>
species SIR_model schedules: [] {
    <span class="hljs-keyword">float</span> S;
    <span class="hljs-keyword">float</span> I;
    <span class="hljs-keyword">float</span> R;
    <span class="hljs-keyword">int</span> N;
    string model_type &lt;- <span class="hljs-string">'none'</span>;
    
    action remove_model {
        <span class="hljs-keyword">do</span> <span class="hljs-keyword">die</span>;
    }

    action initialize ;

}

<span class="hljs-comment">//Species IBM Model which represent the Individual based model, derivated from SIR_model</span>
species IBM_model schedules: [] <span class="hljs-keyword">parent</span>: SIR_model {
    string model_type &lt;- <span class="hljs-string">'IBM'</span>;
    
    <span class="hljs-comment">//Action to initialize the Model with SIR compartiments</span>
    action initialize {
        
        write <span class="hljs-string">'Initializing IBM model with S='</span> + round(S) + <span class="hljs-string">', I='</span> + round(I) + <span class="hljs-string">', R='</span> + round(R) + <span class="hljs-string">'\n'</span>;
        <span class="hljs-comment">//Creation of the host agents</span>
        create Host number: round(S) {
            is_susceptible &lt;- <span class="hljs-keyword">true</span>;
            is_infected &lt;- <span class="hljs-keyword">false</span>;
            is_immune &lt;- <span class="hljs-keyword">false</span>;
            color &lt;- <span class="hljs-comment">#green;</span>
        }

        create Host number: round(I) {
            is_susceptible &lt;- <span class="hljs-keyword">false</span>;
            is_infected &lt;- <span class="hljs-keyword">true</span>;
            is_immune &lt;- <span class="hljs-keyword">false</span>;
            color &lt;- <span class="hljs-comment">#red;</span>
        }

        create Host number: round(R) {
            is_susceptible &lt;- <span class="hljs-keyword">false</span>;
            is_infected &lt;- <span class="hljs-keyword">false</span>;
            is_immune &lt;- <span class="hljs-keyword">true</span>;
            color &lt;- <span class="hljs-comment">#yellow;</span>
        }
        <span class="hljs-keyword">do</span> count;
    }

    reflex count {
        <span class="hljs-keyword">do</span> count;
    }
    <span class="hljs-comment">//Action to update the different compartiments</span>
    action count {
        S &lt;- <span class="hljs-keyword">float</span>(Host count (each.is_susceptible));
        I &lt;- <span class="hljs-keyword">float</span>(Host count (each.is_infected));
        R &lt;- <span class="hljs-keyword">float</span>(Host count (each.is_immune));
    }
    <span class="hljs-comment">//Action to remove the model and kill all the agents it contains</span>
    action remove_model {
        ask Host {
            <span class="hljs-keyword">do</span> <span class="hljs-keyword">die</span>;
        }

        <span class="hljs-keyword">do</span> <span class="hljs-keyword">die</span>;
    }

}

<span class="hljs-comment">//Species Math Model which represent the mathematical Ordinary Differential Equations model, derivated from SIR_model</span>
species Math_model schedules: [] <span class="hljs-keyword">parent</span>: SIR_model {
    string model_type &lt;- <span class="hljs-string">'Maths'</span>;
    <span class="hljs-keyword">float</span> t;
    
    action initialize {
        write <span class="hljs-string">'Initializing Maths model with S='</span> + S + <span class="hljs-string">', I='</span> + I + <span class="hljs-string">', R='</span> + R + <span class="hljs-string">'\n'</span>;
    }

    equation SIR {
        diff(S, t) = (-beta_maths * S * I / N);
        diff(I, t) = (beta_maths * S * I / N) - (delta * I);
        diff(R, t) = (delta * I);
    }

    reflex solving {solve SIR method: <span class="hljs-string">"rk4"</span> step: <span class="hljs-number">0.01</span> ;}
}
<span class="hljs-comment">//Species host used by the Individual Based Model which move from one cell to another</span>
species Host schedules: [] skills: [moving] {
    <span class="hljs-keyword">bool</span> is_susceptible &lt;- <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">bool</span> is_infected &lt;- <span class="hljs-keyword">false</span>;
    <span class="hljs-keyword">bool</span> is_immune &lt;- <span class="hljs-keyword">false</span>;
    rgb color &lt;- <span class="hljs-comment">#green;</span>
    sir_grid myPlace;
    
    <span class="hljs-comment">/* next function computes the number of neighbours of the agent */</span>
    <span class="hljs-keyword">int</span> ngb_number <span class="hljs-function"><span class="hljs-keyword">function</span>: </span>{
        length(((<span class="hljs-keyword">self</span>) neighbors_at (<span class="hljs-number">2</span>)) of_species Host) - <span class="hljs-number">1</span> <span class="hljs-comment">// -1 is because the agent counts itself</span>
    };
    
    init {
        myPlace &lt;- one_of(sir_grid <span class="hljs-keyword">as</span> <span class="hljs-keyword">list</span>);
        location &lt;- myPlace.location;
    }

    <span class="hljs-comment">//Reflex to move the agents among the cells</span>
    reflex basic_move {
        <span class="hljs-keyword">if</span> (!local_random_walk) {
        <span class="hljs-comment">/* random walk among neighbours */</span>
            myPlace &lt;- one_of(myPlace.neighbours);
            location &lt;- myPlace.location;
        } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">/* move agent to a random place anywhere in the grid */</span>
            myPlace &lt;- any(sir_grid);
            location &lt;- myPlace.location;
        }

    }
    <span class="hljs-comment">//Reflex to make the agent infected when the infection is computed from S for a better execution time</span>
    reflex become_infected when: (is_susceptible <span class="hljs-keyword">and</span> computeInfectionFromS) {
        <span class="hljs-keyword">if</span> (flip(<span class="hljs-number">1</span> - (<span class="hljs-number">1</span> - beta) ^ (((<span class="hljs-keyword">self</span>) neighbors_at (<span class="hljs-number">2</span>)) of_species Host) count (each.is_infected))) {
            is_susceptible &lt;- <span class="hljs-keyword">false</span>;
            is_infected &lt;- <span class="hljs-keyword">true</span>;
            is_immune &lt;- <span class="hljs-keyword">false</span>;
            color &lt;- <span class="hljs-comment">#red;</span>
        }

    }
    <span class="hljs-comment">//Reflex to make the agent infect others when the infection is not computed from S for a better execution time</span>
    reflex infecte_others when: (is_infected <span class="hljs-keyword">and</span> not (computeInfectionFromS)) {
        loop hst over: ((<span class="hljs-keyword">self</span>) neighbors_at (<span class="hljs-number">2</span>)) {
            <span class="hljs-keyword">if</span> (hst.is_susceptible) {
                <span class="hljs-keyword">if</span> (flip(beta)) {
                    hst.is_susceptible &lt;- <span class="hljs-keyword">false</span>;
                    hst.is_infected &lt;- <span class="hljs-keyword">true</span>;
                    hst.is_immune &lt;- <span class="hljs-keyword">false</span>;
                    hst.color &lt;- <span class="hljs-comment">#red;</span>
                }
            }
        }
    }
    <span class="hljs-comment">//Reflex to make the agent resistant</span>
    reflex become_immune when: (is_infected <span class="hljs-keyword">and</span> flip(delta)) {
        is_susceptible &lt;- <span class="hljs-keyword">false</span>;
        is_infected &lt;- <span class="hljs-keyword">false</span>;
        is_immune &lt;- <span class="hljs-keyword">true</span>;
        color &lt;- <span class="hljs-comment">#yellow;</span>
    }

    aspect basic {
        draw circle(<span class="hljs-number">1</span>) color: color;
    }

}
<span class="hljs-comment">//Species which represent the SIR mathematical model </span>
species my_SIR_maths {
    <span class="hljs-keyword">float</span> t;
    <span class="hljs-keyword">float</span> I &lt;- <span class="hljs-keyword">float</span>(iInit);
    <span class="hljs-keyword">float</span> S &lt;- N - I;
    <span class="hljs-keyword">float</span> R &lt;- <span class="hljs-number">0.0</span>;
            
    <span class="hljs-keyword">float</span> alpha &lt;- <span class="hljs-number">0.01</span> min: <span class="hljs-number">0.0</span> max: <span class="hljs-number">1.0</span>;
    <span class="hljs-keyword">float</span> beta1 &lt;- <span class="hljs-number">0.1</span> min: <span class="hljs-number">0.0</span> max: <span class="hljs-number">1000.0</span>;
    <span class="hljs-keyword">int</span> N &lt;- <span class="hljs-number">500</span> min: <span class="hljs-number">1</span> max: <span class="hljs-number">3000</span>;
    <span class="hljs-keyword">int</span> iInit &lt;- <span class="hljs-number">1</span>;

    equation SIR {
        diff(S, t) = (-beta1 * S * I / N);
        diff(I, t) = (beta1 * S * I / N) - (alpha * I);
        diff(R, t) = (alpha * I);
    }
    
    reflex solving {solve SIR method:<span class="hljs-string">"rk4"</span> step:<span class="hljs-number">0.01</span>;}

}



experiment mysimulation type: gui {
    parameter <span class="hljs-string">'Number of Susceptible'</span> type: <span class="hljs-keyword">int</span> <span class="hljs-keyword">var</span>: initial_S &lt;- <span class="hljs-number">495</span> category: <span class="hljs-string">"Initial population"</span>; 
    parameter <span class="hljs-string">'Number of Infected'</span>    type: <span class="hljs-keyword">int</span> <span class="hljs-keyword">var</span>: initial_I &lt;- <span class="hljs-number">5</span>   category: <span class="hljs-string">"Initial population"</span>;
    parameter <span class="hljs-string">'Number of Removed'</span>     type: <span class="hljs-keyword">int</span> <span class="hljs-keyword">var</span>: initial_R &lt;- <span class="hljs-number">0</span>   category: <span class="hljs-string">"Initial population"</span>;

    parameter <span class="hljs-string">'Beta (S-&gt;I)'</span>  type: <span class="hljs-keyword">float</span> <span class="hljs-keyword">var</span>: beta &lt;- <span class="hljs-number">1.0</span>   category: <span class="hljs-string">"Parameters"</span>;
    parameter <span class="hljs-string">'Delta (I-&gt;R)'</span> type: <span class="hljs-keyword">float</span> <span class="hljs-keyword">var</span>: delta &lt;- <span class="hljs-number">0.01</span> category: <span class="hljs-string">"Parameters"</span>; 
    
    parameter <span class="hljs-string">'Is the infection is computed locally?'</span> type: <span class="hljs-keyword">bool</span> <span class="hljs-keyword">var</span>: local_infection &lt;- <span class="hljs-keyword">true</span> category: <span class="hljs-string">"Infection"</span>;
    parameter <span class="hljs-string">'Size of the neighbours'</span> type: <span class="hljs-keyword">int</span> <span class="hljs-keyword">var</span>: neighbours_range &lt;- <span class="hljs-number">2</span> min:<span class="hljs-number">1</span> max: <span class="hljs-number">5</span> category: <span class="hljs-string">"Infection"</span>;

    parameter <span class="hljs-string">'Local Random Walk'</span> type: <span class="hljs-keyword">bool</span> <span class="hljs-keyword">var</span>: local_random_walk &lt;- <span class="hljs-keyword">true</span> category: <span class="hljs-string">"Agents"</span>; 
    
    parameter <span class="hljs-string">'Switch models at'</span> type: <span class="hljs-keyword">int</span> <span class="hljs-keyword">var</span>: switch_threshold &lt;- <span class="hljs-number">120</span> category: <span class="hljs-string">"Model"</span>;
    
    output {
        display <span class="hljs-string">'sir display'</span> {
            grid sir_grid lines: <span class="hljs-comment">#black;</span>
            species Host aspect: basic;
        }
    
        display <span class="hljs-string">'Switch model'</span> {
            chart <span class="hljs-string">'Susceptible'</span> type: series background: <span class="hljs-comment">#lightgray style: exploded {</span>
                data <span class="hljs-string">'susceptible'</span> value: current_model.S color: <span class="hljs-comment">#green;</span>
                data <span class="hljs-string">'infected'</span> value: current_model.I color: <span class="hljs-comment">#red;</span>
                data <span class="hljs-string">'immune'</span> value: current_model.R color: <span class="hljs-comment">#yellow;</span>
            }

        }

        display SI_maths  {
            chart <span class="hljs-string">"SI"</span> type: series background: <span class="hljs-comment">#white {</span>
                data <span class="hljs-string">'S'</span> value: first((my_SIR_maths)).S color: <span class="hljs-comment">#green;</span>
                data <span class="hljs-string">'I'</span> value: first((my_SIR_maths)).I color: <span class="hljs-comment">#red;</span>
                data <span class="hljs-string">'R'</span> value: first((my_SIR_maths)).R color: <span class="hljs-comment">#yellow;</span>
            }

        }

    }

}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>