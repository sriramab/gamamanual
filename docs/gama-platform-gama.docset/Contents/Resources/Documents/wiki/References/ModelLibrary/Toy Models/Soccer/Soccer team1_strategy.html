<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Soccer/Soccer team1_strategy --><head><meta charset="utf-8"><title>Soccer team1_strategy</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="soccer-team1_strategy">Soccer team1_strategy</h1>
<h1 id="_team1strategy">_team1strategy</h1>
<p><em>Author : Julien</em></p>
<p>This model contains one of the 2 team strategy. This strategy is quite advanced, attributing role for each player, with a custom influence_area and a custom position_mark.</p>
<p>Imported model : </p>
<pre><code class="hljs sqf">
model soccerbase

species soccer_game {
    <span class="hljs-comment">// contains the global informations of the game</span>
    rgb back_color_team;
    rgb front_color_team;
    
    ball_sp ball; <span class="hljs-comment">// the ball agent</span>
    goal_sp front_goal; <span class="hljs-comment">// contains the goal at the front of the field (y = 120)</span>
    goal_sp back_goal; <span class="hljs-comment">// contains the goal at the back of the field (y = 0)</span>
    <span class="hljs-built_in">list</span>&lt;base_team&gt; <span class="hljs-built_in">teams</span>; <span class="hljs-comment">// contains the 2 teams</span>
    <span class="hljs-built_in">list</span>&lt;base_player&gt; players; <span class="hljs-comment">// contains all the players of the game</span>
    
    base_team team_possession; <span class="hljs-comment">// the last team which possess the ball. This value is used to determine if the behavior of the team has to be defensive or offensive.</span>
    
    init {
        <span class="hljs-comment">// create the entities ball and the 2 goals</span>
        create ball_sp <span class="hljs-keyword">with</span>:[<span class="hljs-built_in">location</span>::world.<span class="hljs-built_in">location</span>] returns:var_ball;
        ball &lt;- first(var_ball);
        create goal_sp <span class="hljs-keyword">with</span>:[<span class="hljs-built_in">location</span>::{world.<span class="hljs-built_in">location</span>.x,<span class="hljs-number">120</span>},<span class="hljs-built_in">position</span>::<span class="hljs-string">"front"</span>] returns:var_goal1;
        front_goal &lt;- first(var_goal1);
        create goal_sp <span class="hljs-keyword">with</span>:[<span class="hljs-built_in">location</span>::{world.<span class="hljs-built_in">location</span>.x,<span class="hljs-number">0</span>},<span class="hljs-built_in">position</span>::<span class="hljs-string">"back"</span>] returns:var_goal2;
        back_goal &lt;- first(var_goal2);
    }
    
    <span class="hljs-built_in">action</span> reinit_phase {
        <span class="hljs-comment">// this action is called when a goal has been scored : the players are placed with their initial position, and the ball is reset to the center</span>
        ask players {
            <span class="hljs-built_in">location</span> &lt;- init_pos;
            previous_pos &lt;- init_pos;
        }
        ball.<span class="hljs-built_in">location</span> &lt;- world.<span class="hljs-built_in">location</span>;
        ball.destination &lt;- world.<span class="hljs-built_in">location</span>;
        ball.<span class="hljs-built_in">speed</span> &lt;- <span class="hljs-number">0.0</span>;
    }
}

species base_player skills:[moving] {
    <span class="hljs-comment">// ATTRIBUTES ////////////////////////////////////////////////</span>
    
    <span class="hljs-comment">// ATTRIBUTES ONLY USED IN THIS BASE CLASSE, SHOULD NEVER BEEN CALLED IN STRATEGY FILE</span>
    float recuperation_ability &lt;- <span class="hljs-number">0.2</span>; <span class="hljs-comment">// a mark from 0 to 1 to be able to catch the ball if another player has it</span>
    float speed_without_ball;
    float speed_with_ball;
    point previous_pos; <span class="hljs-comment">// used to apply inertia</span>
    bool displacement_effectued&lt;-<span class="hljs-literal">false</span> update:<span class="hljs-literal">false</span>; <span class="hljs-comment">// we can apply only one displacement by step !</span>
    
    <span class="hljs-comment">// ATTRIBUTE USEFUL TO BE READ IN THE TEAM STRATEGY FILE (READ ONLY !)</span>
    base_team team;
    soccer_game game;
    base_team ennemy_team &lt;- <span class="hljs-literal">nil</span> update:first(game.<span class="hljs-built_in">teams</span> where (each.<span class="hljs-built_in">position</span> != team.<span class="hljs-built_in">position</span>));
    ball_sp ball &lt;- <span class="hljs-literal">nil</span> update:first(ball_sp);
    goal_sp own_goal &lt;- <span class="hljs-literal">nil</span> update:first(goal_sp where (each.<span class="hljs-built_in">position</span> = team.<span class="hljs-built_in">position</span>));
    goal_sp ennemy_goal &lt;- <span class="hljs-literal">nil</span> update:first(goal_sp where (each.<span class="hljs-built_in">position</span> != team.<span class="hljs-built_in">position</span>));
    <span class="hljs-comment">// ratio of avancement of the ball (from the point of view of the current team)</span>
    float ball_advancement &lt;- <span class="hljs-number">0.0</span> update:(team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? ball.<span class="hljs-built_in">location</span>.y / <span class="hljs-number">120</span> : <span class="hljs-number">1</span> - ball.<span class="hljs-built_in">location</span>.y / <span class="hljs-number">120</span>;
    
    bool possess_ball;
    point init_pos;
    point init_pos_in_percent;
    float distance_to_closest_ennemy_player &lt;- <span class="hljs-number">100.0</span> update:self distance_to closest_ennemy_player;
    <span class="hljs-comment">// the number of ennemy players in a range of 15 meters</span>
    int number_of_ennemy_player_in_range &lt;- <span class="hljs-number">0</span> update:length((game.players where (each.team != team)) where ((each intersects circle(<span class="hljs-number">15</span>))=<span class="hljs-literal">true</span>));
    float distance_to_ball &lt;- <span class="hljs-number">100.0</span> update:(ball = <span class="hljs-literal">nil</span>) ? <span class="hljs-number">100.0</span> : self distance_to ball;
    float distance_to_goal &lt;- <span class="hljs-number">100.0</span> update:(ennemy_goal = <span class="hljs-literal">nil</span>) ? <span class="hljs-number">100.0</span> : self distance_to ennemy_goal;
    <span class="hljs-comment">// the closest player of this team</span>
    base_player closest_friend_player &lt;- <span class="hljs-literal">nil</span> update:(ball = <span class="hljs-literal">nil</span>) ? base_player(<span class="hljs-literal">nil</span>) : first( (game.players where (each.team = team <span class="hljs-built_in">and</span> each != self)) 
        where (each distance_to self = <span class="hljs-built_in">min</span>( (game.players where (each.team = team <span class="hljs-built_in">and</span> each != self)) collect (each distance_to self) ) ) 
    );
    <span class="hljs-comment">// the closest ennemy player</span>
    base_player closest_ennemy_player &lt;- <span class="hljs-literal">nil</span> update:(ball = <span class="hljs-literal">nil</span>) ? base_player(<span class="hljs-literal">nil</span>) : first( (game.players where (each.team != team <span class="hljs-built_in">and</span> each != self)) 
        where (each distance_to self = <span class="hljs-built_in">min</span>( (game.players where (each.team != team <span class="hljs-built_in">and</span> each != self)) collect (each distance_to self) ) ) 
    );
    <span class="hljs-comment">// the player of this team wich has the best "position_mark"</span>
    base_player best_position_player &lt;- <span class="hljs-literal">nil</span> update:first((team.players where (each != self)) 
        where (each.position_mark = <span class="hljs-built_in">max</span>((team.players where (each != self)) collect (each.position_mark)))
    );
    float current_speed&lt;-<span class="hljs-number">1.0</span> update:(possess_ball) ? speed_with_ball : speed_without_ball;
    
    <span class="hljs-comment">// ATTRIBUTES WICH CAN BE CHANGED FROM THE TEAM STRAGEGY FILE</span>
    float position_mark &lt;- <span class="hljs-number">0.0</span> update:-distance_to_goal; <span class="hljs-comment">// a mark attributed according to the position of the player (the higher the note is, the best the position is). </span>
    <span class="hljs-comment">// By default, this mark is equal to -distance_to_goal.</span>
    string status &lt;- <span class="hljs-string">""</span>; <span class="hljs-comment">// the current status of the player (can be useful to build the model)</span>
    geometry influence_area &lt;- <span class="hljs-literal">nil</span> update:circle(<span class="hljs-number">15</span>); <span class="hljs-comment">// the area of interest of the player. By default, this area is a circle 15m diameter centered in the player location.</span>

    
    <span class="hljs-comment">// CONSTRUCTOR /////////////////////////////////////////////</span>
    init {
        init_pos &lt;- <span class="hljs-built_in">location</span>;
        previous_pos &lt;- <span class="hljs-built_in">location</span>;
        possess_ball &lt;- <span class="hljs-literal">false</span>;
        speed_with_ball &lt;- <span class="hljs-number">0.4</span>;
        speed_without_ball &lt;- <span class="hljs-number">0.5</span>;
    }
    
    <span class="hljs-comment">// ACTIONS ////////////////////////////////////////////////////</span>
    
    <span class="hljs-comment">// ACTIONS TO CALL FROM THE STRATEGY FILE</span>
    <span class="hljs-comment">// action to run to a particular position</span>
    <span class="hljs-built_in">action</span> run_to(point target) {
        <span class="hljs-keyword">if</span> (!displacement_effectued) {
                <span class="hljs-keyword">do</span> <span class="hljs-built_in">goto</span> target:target <span class="hljs-built_in">speed</span>:current_speed;
            <span class="hljs-keyword">if</span> (possess_ball) {
                ball.<span class="hljs-built_in">location</span> &lt;- <span class="hljs-built_in">location</span>;
            }
            displacement_effectued &lt;- <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> {
            write <span class="hljs-string">"WARNING : only ONE action of displacement is allowed each step"</span>;
        }
    }
    
    <span class="hljs-comment">// action to run to the ball</span>
    <span class="hljs-built_in">action</span> run_to_ball {
        point targetPos;
        <span class="hljs-keyword">if</span> (ball.ball_direction intersects circle(<span class="hljs-number">1</span>)) {
            targetPos &lt;- ball.<span class="hljs-built_in">location</span>;
        }
        <span class="hljs-keyword">else</span> {
            targetPos &lt;- (ball.ball_direction closest_points_with self) at <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">do</span> run_to(targetPos);
    }
    
    <span class="hljs-comment">// action to run to the ennemy goal</span>
    <span class="hljs-built_in">action</span> run_to_ennemy_goal {
        <span class="hljs-keyword">do</span> run_to( ennemy_goal.<span class="hljs-built_in">location</span> );
    }
    
    <span class="hljs-comment">// action to run to its own goal</span>
    <span class="hljs-built_in">action</span> run_to_own_goal {
        <span class="hljs-keyword">do</span> run_to( own_goal.<span class="hljs-built_in">location</span> );
    }
    
    <span class="hljs-comment">// action to mark a player</span>
    <span class="hljs-built_in">action</span> mark_player (base_player <span class="hljs-built_in">player</span>) {
        float rnd_area &lt;- <span class="hljs-number">4.0</span>; <span class="hljs-comment">// the player will choose a position in a square of rnd_area m.</span>
        point pos &lt;- (team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"front"</span>) ? {<span class="hljs-built_in">player</span>.<span class="hljs-built_in">location</span>.x,<span class="hljs-built_in">player</span>.<span class="hljs-built_in">location</span>.y-rnd_area/<span class="hljs-number">2</span>} : {<span class="hljs-built_in">player</span>.<span class="hljs-built_in">location</span>.x,<span class="hljs-built_in">player</span>.<span class="hljs-built_in">location</span>.y+rnd_area/<span class="hljs-number">2</span>};
        <span class="hljs-keyword">do</span> run_to( {pos.x-rnd_area/<span class="hljs-number">2</span>+rnd(rnd_area),pos.y-rnd_area/<span class="hljs-number">2</span>+rnd(rnd_area)} );
    }
    
    <span class="hljs-comment">// action ot shoot the ball to the ennemy goal</span>
    <span class="hljs-built_in">action</span> shoot {
        <span class="hljs-keyword">do</span> loose_ball;
        ask ball {
            <span class="hljs-keyword">do</span> shooted speed_atr:<span class="hljs-number">3.0</span> target_position:myself.ennemy_goal.<span class="hljs-built_in">location</span>;
        }
    }
    
    <span class="hljs-comment">// action to pass the ball to an ally</span>
    <span class="hljs-built_in">action</span> pass_the_ball (base_player target_player) {
        <span class="hljs-keyword">do</span> loose_ball;
        ask ball {
            <span class="hljs-keyword">do</span> shooted target_position:target_player.<span class="hljs-built_in">location</span> speed_atr:target_player.distance_to_ball/<span class="hljs-number">15</span>;
        }
        team.called_player &lt;- target_player;
    }
    
    <span class="hljs-comment">// action to pass the ball to an ally</span>
    <span class="hljs-built_in">action</span> pass_the_ball_ahead (base_player target_player,float number_of_meter_ahead) {
        <span class="hljs-keyword">do</span> loose_ball;
        ask ball {
            float offset &lt;- ((myself.team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? number_of_meter_ahead : -number_of_meter_ahead);
            point target_point &lt;- {target_player.<span class="hljs-built_in">location</span>.x,target_player.<span class="hljs-built_in">location</span>.y+offset};
            <span class="hljs-keyword">do</span> shooted target_position:target_point speed_atr:target_player.distance_to_ball/<span class="hljs-number">15</span>;
        }
        team.called_player &lt;- target_player;
    }
    
    <span class="hljs-comment">// ACTION AUTOMATICALLY CALLED IN THE BASE CLASSE</span>
    <span class="hljs-comment">// try to take the ball if it is close enough</span>
    <span class="hljs-built_in">action</span> try_to_take_ball {
        <span class="hljs-comment">// if no player has the ball</span>
        <span class="hljs-keyword">if</span> (!team.possess_ball <span class="hljs-built_in">and</span> !ennemy_team.possess_ball) {
            <span class="hljs-comment">// if the player is the one called (result of a pass)</span>
            <span class="hljs-keyword">if</span> (team.called_player = self) {
                <span class="hljs-keyword">do</span> take_ball;
            }
            <span class="hljs-comment">// if the player is not the one called (interception of the ball), probability to catch the ball inversly proportionnal with the speed of the ball</span>
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (flip(<span class="hljs-number">1</span>/(<span class="hljs-number">1</span>+<span class="hljs-number">2</span>*ball.<span class="hljs-built_in">speed</span>))) {
                    <span class="hljs-keyword">do</span> take_ball;
                }
            }
        }
        <span class="hljs-comment">// the ball is possessed by the ennemy team</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ennemy_team.possess_ball) {
            <span class="hljs-comment">// try to catch the ball from the other player</span>
            <span class="hljs-keyword">if</span> flip(recuperation_ability) {
                <span class="hljs-keyword">do</span> take_ball;
            }
        }
    }
    
    <span class="hljs-comment">// action of taking the ball</span>
    <span class="hljs-built_in">action</span> take_ball {
        <span class="hljs-keyword">if</span> (ennemy_team.possess_ball) {
            ask ennemy_team.player_with_ball {
                <span class="hljs-keyword">do</span> loose_ball;
            }
        }
        possess_ball &lt;- <span class="hljs-literal">true</span>;
        ball.<span class="hljs-built_in">speed</span> &lt;- <span class="hljs-number">0.0</span>;
        ball.destination &lt;- ball.<span class="hljs-built_in">location</span>;
        team.called_player &lt;- <span class="hljs-literal">nil</span>;
        team.player_with_ball &lt;- self;
        team.possess_ball &lt;- <span class="hljs-literal">true</span>;
        game.team_possession &lt;- team;
    }
    
    <span class="hljs-comment">// action of loosing the ball</span>
    <span class="hljs-built_in">action</span> loose_ball {
        possess_ball &lt;- <span class="hljs-literal">false</span>;
        team.player_with_ball &lt;- <span class="hljs-literal">nil</span>;
        team.possess_ball &lt;- <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// apply the inertia</span>
    <span class="hljs-built_in">action</span> apply_inertia {
        point prev_pos &lt;- <span class="hljs-built_in">location</span>;
        point inertia_vect &lt;- {(<span class="hljs-built_in">location</span>.x-previous_pos.x)*<span class="hljs-number">0.7</span>,(<span class="hljs-built_in">location</span>.y-previous_pos.y)*<span class="hljs-number">0.7</span>};
        float max_inertia &lt;- current_speed;
        <span class="hljs-keyword">if</span> (norm(inertia_vect) &gt; max_inertia) {
            float inertia_x &lt;-  <span class="hljs-built_in">sqrt</span>(<span class="hljs-built_in">abs</span>(max_inertia*max_inertia-inertia_vect.y*inertia_vect.y));
            float inertia_y &lt;-  <span class="hljs-built_in">sqrt</span>(<span class="hljs-built_in">abs</span>(max_inertia*max_inertia-inertia_vect.x*inertia_vect.x));
            inertia_x &lt;- (inertia_vect.x &lt; <span class="hljs-number">0</span>) ? -inertia_x : inertia_x;
            inertia_y &lt;- (inertia_vect.y &lt; <span class="hljs-number">0</span>) ? -inertia_y : inertia_y;
            inertia_vect &lt;- {inertia_x,inertia_y};
        }
        <span class="hljs-built_in">location</span> &lt;- <span class="hljs-built_in">location</span> + inertia_vect;
        previous_pos &lt;- prev_pos;
    }
    
    <span class="hljs-comment">// useful functions</span>
    <span class="hljs-comment">// this function returns the real x if we pass a percentage : 0 is the extreme left point, 100 is the extreme right point.</span>
    float getXPos(float x_ratio) {
        float result;
        <span class="hljs-keyword">if</span> (team.<span class="hljs-built_in">position</span>=<span class="hljs-string">"back"</span>) {
            result &lt;- <span class="hljs-number">90</span>-x_ratio*<span class="hljs-number">90</span>;
        }
        <span class="hljs-keyword">else</span> {
            result &lt;- x_ratio*<span class="hljs-number">90</span>;
        }
        return result;
    }
    
    <span class="hljs-comment">// this function returns the real y if we pass a percentage : 0 is the extreme defensive point, 100 is the extreme attack point.</span>
    float getYPos(float y_ratio) {
        float result;
        <span class="hljs-keyword">if</span> (team.<span class="hljs-built_in">position</span>=<span class="hljs-string">"back"</span>) {
            result &lt;- y_ratio*<span class="hljs-number">120</span>;
        }
        <span class="hljs-keyword">else</span> {
            result &lt;- <span class="hljs-number">120</span>-y_ratio*<span class="hljs-number">120</span>;
        }
        return result;
    }
    
    <span class="hljs-comment">///////////////////////////////////////////////////////</span>
    
    <span class="hljs-comment">// The update function, calls the adequate behavior</span>
    reflex update when:cycle&gt;<span class="hljs-number">1</span> {
        <span class="hljs-keyword">do</span> apply_inertia;
        <span class="hljs-comment">// verify if it is a non-offside position</span>
        <span class="hljs-keyword">if</span> ( (((team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) <span class="hljs-built_in">and</span> (<span class="hljs-built_in">location</span>.y &gt; team.offside_pos))
            <span class="hljs-built_in">or</span> ((team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"front"</span>) <span class="hljs-built_in">and</span> (<span class="hljs-built_in">location</span>.y &lt; team.offside_pos))) 
            <span class="hljs-built_in">and</span> (!possess_ball) <span class="hljs-built_in">and</span> (self != team.called_player)
        ) {
            <span class="hljs-comment">// offside position, go back to a correct position</span>
            point target_pos &lt;- {<span class="hljs-built_in">location</span>.x,(team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? <span class="hljs-built_in">location</span>.y-current_speed:<span class="hljs-built_in">location</span>.y+current_speed};
            <span class="hljs-keyword">do</span> run_to(target_pos);
            status &lt;- <span class="hljs-string">"offside position !"</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((distance_to_ball &lt; <span class="hljs-number">2</span>) <span class="hljs-built_in">and</span> !possess_ball) {
            <span class="hljs-keyword">do</span> try_to_take_ball;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (game.team_possession = team) {
            <span class="hljs-keyword">do</span> offensive_behavior;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">do</span> defensive_behavior;
        }
    }
    
    <span class="hljs-comment">// defensive behavior, need to be redefined in the strategy file.</span>
    <span class="hljs-comment">// this action is called when the last player who was holding the ball was a player of the ennemy team</span>
    <span class="hljs-built_in">action</span> defensive_behavior virtual:<span class="hljs-literal">true</span> {
        
    }
    <span class="hljs-comment">// defensive behavior, need to be redefined in the strategy file.</span>
    <span class="hljs-comment">// this action is called when the last player who was holding the ball was a player of this team</span>
    <span class="hljs-built_in">action</span> offensive_behavior virtual:<span class="hljs-literal">true</span> {
        
    }
    
    
    <span class="hljs-comment">// ASPECT ////////////////////////////////////////////////////////</span>
    aspect <span class="hljs-built_in">player</span> {
        <span class="hljs-comment">// the player wich possess the ball is displayed with a square. It is displayed with a circle otherwise.</span>
        <span class="hljs-keyword">if</span> (possess_ball) {
            draw square(<span class="hljs-number">2</span>) color:(team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? game.back_color_team : game.front_color_team;
        }
        <span class="hljs-keyword">else</span> {
            draw circle(<span class="hljs-number">1</span>) color:(team.<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? game.back_color_team : game.front_color_team;
        }
    }
}



species base_team {
    <span class="hljs-comment">// ATTRIBUTES ////////////////////////////////////////////////</span>
    
    <span class="hljs-comment">// ATTRIBUTES ONLY USED IN THIS BASE CLASSE, SHOULD NEVER BEEN CALLED IN STRATEGY FILE</span>
    float offside_pos &lt;- <span class="hljs-number">0.0</span> update: (<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? <span class="hljs-built_in">max</span>((game.players where (each.team != self)) collect (each.<span class="hljs-built_in">location</span>.y))
        : <span class="hljs-built_in">min</span>((game.players where (each.team != self)) collect (each.<span class="hljs-built_in">location</span>.y));
    
    <span class="hljs-comment">// ATTRIBUTES USEFUL TO BE READ IN THE TEAM STRATEGY FILE (READ ONLY !)</span>
    string <span class="hljs-built_in">position</span>; <span class="hljs-comment">// can be "front" or "back".</span>
    <span class="hljs-built_in">list</span>&lt;base_player&gt; players; <span class="hljs-comment">// all the players of the team.</span>
    soccer_game game;
    
    base_player closest_player_to_ball &lt;- first(players) update: first( players where (each distance_to each.ball = <span class="hljs-built_in">min</span> (players collect (each distance_to each.ball) ) ) );
    base_player called_player;
    bool possess_ball &lt;- <span class="hljs-literal">false</span>;<span class="hljs-comment">// update: ! empty ( players where (each.possess_ball=true) );</span>
    base_player player_with_ball &lt;- <span class="hljs-literal">nil</span>;<span class="hljs-comment">// update: first(players where (each.possess_ball = true));</span>
    
    <span class="hljs-comment">// ATTRIBUTES WICH CAN BE CHANGED FROM THE TEAM STRATEGY FILE</span>
    <span class="hljs-built_in">list</span>&lt;point&gt; player_init_position;
}

species ball_sp skills:[moving] {
    <span class="hljs-comment">// The ball agent.</span>
    float <span class="hljs-built_in">speed</span> &lt;- <span class="hljs-number">0.0</span>;
    geometry ball_direction; <span class="hljs-comment">// the direction of the ball is used to be followed by the player</span>
    reflex update {
        <span class="hljs-built_in">speed</span> &lt;- <span class="hljs-built_in">speed</span>*<span class="hljs-number">0.95</span>;
        float future_speed &lt;- <span class="hljs-built_in">speed</span>;
        point tmpPos&lt;-<span class="hljs-built_in">location</span>;
        loop i <span class="hljs-keyword">from</span>:<span class="hljs-number">0</span> <span class="hljs-keyword">to</span>:<span class="hljs-number">10</span> {
            tmpPos &lt;- {tmpPos.x+<span class="hljs-built_in">cos</span>(heading)*<span class="hljs-built_in">speed</span>,tmpPos.y+<span class="hljs-built_in">sin</span>(heading)*<span class="hljs-built_in">speed</span>};
            future_speed &lt;- future_speed*<span class="hljs-number">0.9</span>;
        }
        ball_direction &lt;- line([<span class="hljs-built_in">location</span>,tmpPos]);
        <span class="hljs-keyword">do</span> wander amplitude:<span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// anticipation of the ball position to detect a goal</span>
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">location</span>.y+<span class="hljs-built_in">sin</span>(heading)*<span class="hljs-built_in">speed</span>) &gt; <span class="hljs-number">120</span>) {
            write <span class="hljs-string">"back team score a goal !!"</span>;
            ask first(soccer_game) {
                <span class="hljs-keyword">do</span> reinit_phase;
            }
        }
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">location</span>.y+<span class="hljs-built_in">sin</span>(heading)*<span class="hljs-built_in">speed</span>) &lt; <span class="hljs-number">0</span>) {
            write <span class="hljs-string">"front team score a goal !!"</span>;
            ask first(soccer_game) {
                <span class="hljs-keyword">do</span> reinit_phase;
            }
        }
    }
    <span class="hljs-built_in">action</span> shooted (point target_position, float speed_atr) {
        <span class="hljs-comment">// action called when a player shoots the ball</span>
        <span class="hljs-built_in">speed</span> &lt;- speed_atr;
        <span class="hljs-keyword">do</span> <span class="hljs-built_in">goto</span> target:target_position;
    }
    
    aspect ball {
        draw circle(<span class="hljs-number">0.5</span>) color:<span class="hljs-meta">#white;</span>
    }
}

species goal_sp {
    string <span class="hljs-built_in">position</span>; <span class="hljs-comment">// can be "front" or "back".</span>
    
    init {
        create goal_keeper <span class="hljs-keyword">with</span>:[<span class="hljs-built_in">position</span>::<span class="hljs-built_in">position</span>];
    }
    
    aspect goal {
        draw rectangle(<span class="hljs-number">7.32</span>,<span class="hljs-number">1.0</span>) color:<span class="hljs-meta">#black;</span>
    }
}

species goal_keeper {
    <span class="hljs-comment">// the goal has a basic behavior : he tries to catch the ball when it is close enough, and when </span>
    string <span class="hljs-built_in">position</span>; <span class="hljs-comment">// can be "front" or "back".</span>
    ball_sp ball &lt;- <span class="hljs-literal">nil</span> update:first(ball_sp);
    
    reflex update when:cycle&gt;<span class="hljs-number">0</span> {
        <span class="hljs-built_in">location</span> &lt;- {ball.<span class="hljs-built_in">location</span>.x/<span class="hljs-number">90</span>*<span class="hljs-number">12</span>+(<span class="hljs-number">90</span>-<span class="hljs-number">12</span>)/<span class="hljs-number">2</span>,<span class="hljs-built_in">location</span>.y};
        <span class="hljs-keyword">if</span> (ball distance_to self &lt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">if</span> (flip(<span class="hljs-number">1</span>/(<span class="hljs-number">1</span>+<span class="hljs-number">2</span>*ball.<span class="hljs-built_in">speed</span>))) {
                first(soccer_game).team_possession &lt;- first(first(soccer_game).<span class="hljs-built_in">teams</span> where (each.<span class="hljs-built_in">position</span> = <span class="hljs-built_in">position</span>));
                ask ball {
                    <span class="hljs-keyword">do</span> shooted ({<span class="hljs-number">30</span>+rnd(<span class="hljs-number">30</span>),<span class="hljs-number">60</span>},<span class="hljs-number">5.0</span>);
                }
            }
        }
    }
    
    init {
        <span class="hljs-built_in">location</span> &lt;- {<span class="hljs-number">45</span>,(<span class="hljs-built_in">position</span>=<span class="hljs-string">"front"</span>) ? <span class="hljs-number">117</span> : <span class="hljs-number">3</span>};
    }
    
    <span class="hljs-built_in">action</span> offensive_behavior {
    }
    
    <span class="hljs-built_in">action</span> defensive_behavior {
    }
    
    aspect goal_keeper {
        draw circle(<span class="hljs-number">1</span>) color:(<span class="hljs-built_in">position</span> = <span class="hljs-string">"back"</span>) ? first(soccer_game).back_color_team : first(soccer_game).front_color_team;
    }
}
</code></pre>
<p>Code of the model : </p>
<pre><code class="hljs lasso">
model team1strategy

<span class="hljs-keyword">import</span> <span class="hljs-string">"./soccer_base.gaml"</span>

species player_intelligentTeam <span class="hljs-keyword">parent</span>:base_player {
    <span class="hljs-comment">// READ ONLY ATTRIBUTES :</span>
    <span class="hljs-comment">// position : can be "front" or "back".</span>
    <span class="hljs-comment">// players : list of all the players of the team.</span>
    <span class="hljs-comment">// game</span>
    <span class="hljs-comment">//closest_player_to_ball</span>
    <span class="hljs-comment">// called_player : the player called for a pass</span>
    <span class="hljs-comment">// possess_ball : true or false</span>
    <span class="hljs-comment">// player_with_ball : player currently with the ball</span>
    
    <span class="hljs-comment">// READ AND WRITE ATTRIBUTES :</span>
    <span class="hljs-comment">// position_mark</span>
    <span class="hljs-comment">// status : the current status of the player (can be useful to build the model)</span>
    <span class="hljs-comment">// influence_area : the area of interest of the player. By default, this area is a circle 15m diameter centered in the player location.</span>
    
    float position_mark &lt;- <span class="hljs-number">0.0</span> update: location.y - <span class="hljs-number">20</span>*number_of_ennemy_player_in_range + <span class="hljs-built_in">self</span>.distance_to_closest_ennemy_player;   
    <span class="hljs-built_in">string</span> role; <span class="hljs-comment">// a value between "defense", "mid" and "attack".</span>
    <span class="hljs-built_in">string</span> wing; <span class="hljs-comment">// a value between "left", "center" and "right".</span>
    geometry influence_area &lt;- circle(<span class="hljs-number">15</span>,init_pos);
    
    float defense_mid_pos &lt;- <span class="hljs-number">30.0</span>; <span class="hljs-comment">// the y percent chosed to separate the defense from the mid position.</span>
    float mid_attack_pos &lt;- <span class="hljs-number">60.0</span>; <span class="hljs-comment">// the y percent chosen to separate the mid from the attack position.</span>
    
    init {
        <span class="hljs-comment">// set the role of the player (between "defense", "mid" and "attack").</span>
        <span class="hljs-keyword">if</span> ( init_pos_in_percent.y &lt; defense_mid_pos ) {
            role &lt;- <span class="hljs-string">"defense"</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( (init_pos_in_percent.y &gt; mid_attack_pos ) ) {
            role &lt;- <span class="hljs-string">"attack"</span>;
        }
        <span class="hljs-keyword">else</span> {
            role &lt;- <span class="hljs-string">"mid"</span>;
        }
        <span class="hljs-comment">// set the wing of the player (between "left", "center" and "right")</span>
        <span class="hljs-keyword">if</span> ( init_pos_in_percent.x &lt; <span class="hljs-number">40</span> ) {
            wing &lt;- <span class="hljs-string">"left"</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( init_pos_in_percent.x &gt; <span class="hljs-number">60</span> ) {
            wing &lt;- <span class="hljs-string">"right"</span>;
        }
        <span class="hljs-keyword">else</span> {
            wing &lt;- <span class="hljs-string">"center"</span>;
        }
    }
    
    action update_influence_area {
        status &lt;- wing + <span class="hljs-string">" "</span> + role;
        float y_ratio;
        <span class="hljs-keyword">if</span> (role = <span class="hljs-string">"defense"</span>) { <span class="hljs-comment">// defense position from 0% to 70% from the own goal, multiplied by the percentage of advancement of the ball</span>
            y_ratio &lt;- <span class="hljs-number">0.7</span> * ball_advancement;
        }
        <span class="hljs-keyword">if</span> (role = <span class="hljs-string">"mid"</span>) { <span class="hljs-comment">// mid position from 15% to 85% from the own goal, multiplied by the percentage of advancement of the ball</span>
            y_ratio &lt;- <span class="hljs-number">0.15</span> + <span class="hljs-number">0.7</span> * ball_advancement;
        }
        <span class="hljs-keyword">if</span> (role = <span class="hljs-string">"attack"</span>) { <span class="hljs-comment">// attack position from 30% to 100% from the own goal, multiplied by the percentage of advancement of the ball</span>
            y_ratio &lt;- <span class="hljs-number">0.3</span> + <span class="hljs-number">0.7</span> * ball_advancement;
        }
        float x_ratio;
        <span class="hljs-keyword">if</span> (wing = <span class="hljs-string">"center"</span>) {
            x_ratio &lt;- <span class="hljs-number">0.5</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (wing = <span class="hljs-string">"left"</span>) {
            x_ratio &lt;- <span class="hljs-number">0.5</span> - <span class="hljs-number">0.3</span> * cos( (y_ratio<span class="hljs-number">-0.5</span>)*<span class="hljs-number">120</span> ); <span class="hljs-comment">// the "side" wings are more marked if the player is in the center of the field.</span>
        }
        <span class="hljs-keyword">else</span> {
            x_ratio &lt;- <span class="hljs-number">0.5</span> + <span class="hljs-number">0.3</span> * cos( (y_ratio<span class="hljs-number">-0.5</span>)*<span class="hljs-number">120</span> );
        }
        influence_area &lt;- circle(<span class="hljs-number">15</span>,{getXPos(x_ratio),getYPos(y_ratio)});
    }
    
    action defensive_behavior { 
        <span class="hljs-keyword">do</span> update_influence_area;
        <span class="hljs-comment">// advanced defensive behavior</span>
        <span class="hljs-comment">// run to the ball if the player is the closest player from the ball.</span>
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">self</span> = team.closest_player_to_ball) <span class="hljs-keyword">or</span> (<span class="hljs-built_in">self</span> distance_to ball &lt; <span class="hljs-number">5</span>)) {
            status &lt;- getStatus(<span class="hljs-string">"run to ball"</span>);
            <span class="hljs-keyword">do</span> run_to_ball;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// if there is an ennemy player in the influence area, mark the player.</span>
            <span class="hljs-keyword">if</span> ( length(<span class="hljs-built_in">self</span>.ennemy_team.players <span class="hljs-keyword">where</span> (each intersects influence_area)) != <span class="hljs-number">0</span> ) {
                base_player marked_player &lt;- first(<span class="hljs-number">1</span> among (<span class="hljs-built_in">self</span>.ennemy_team.players <span class="hljs-keyword">where</span> (each intersects influence_area)));
                status &lt;- getStatus(<span class="hljs-string">"mark player "</span>+marked_player);
                <span class="hljs-keyword">do</span> mark_player( marked_player );
            }
            <span class="hljs-comment">// if there is no ennemy player in the influence area, stay in influence area.</span>
            <span class="hljs-keyword">else</span> {
                status &lt;- getStatus(<span class="hljs-string">"run to influence area"</span>);
                <span class="hljs-keyword">do</span> run_to(influence_area.location);
            }
        }
    }
    
    action offensive_behavior { 
        <span class="hljs-keyword">do</span> update_influence_area;
        <span class="hljs-comment">// advanced offensive behavior</span>
        <span class="hljs-keyword">if</span> (possess_ball) {
            <span class="hljs-comment">// if the player has the ball and is close enough to the ennemy goal, shoot.</span>
            <span class="hljs-keyword">if</span> (distance_to_goal &lt; <span class="hljs-number">35</span> <span class="hljs-keyword">and</span> flip(<span class="hljs-number">1</span>/(<span class="hljs-number">0.1</span>+(<span class="hljs-built_in">self</span>.distance_to_goal/<span class="hljs-number">10</span>)^<span class="hljs-number">2</span>))) {
                status &lt;- getStatus(<span class="hljs-string">"shoot the ball"</span>);
                <span class="hljs-keyword">do</span> shoot;
            }
            <span class="hljs-comment">// if the player has the ball and is in a safe position, run to the ennemy goal.</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( (position_mark = <span class="hljs-keyword">max</span>( team.players collect (each.position_mark) )) <span class="hljs-keyword">or</span> (distance_to_closest_ennemy_player &gt; <span class="hljs-number">2</span>) )
            {
                status &lt;- getStatus(<span class="hljs-string">"run to ennemy goal"</span>);
                <span class="hljs-keyword">do</span> run_to_ennemy_goal;
            }
            <span class="hljs-comment">// if the player has the ball but is in a dangerous situation, pass the ball to another player.</span>
            <span class="hljs-keyword">else</span> {
                base_player target_player &lt;- first(team.players <span class="hljs-keyword">where</span> (each.position_mark = <span class="hljs-keyword">max</span>( team.players collect (each.position_mark)) ) );
                status &lt;- getStatus(<span class="hljs-string">"pass the ball to "</span>+target_player);
                <span class="hljs-keyword">do</span> pass_the_ball_ahead ( target_player,<span class="hljs-number">10.0</span> );
            }
        }
        <span class="hljs-comment">// if the player has not the ball but is the called player, run to the ball.</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span> = team.called_player) {
            status &lt;- getStatus(<span class="hljs-string">"run to ball"</span>);
            <span class="hljs-keyword">do</span> run_to_ball;
            status &lt;- <span class="hljs-string">"called player"</span>;
        }
        <span class="hljs-comment">// else, run to influence area.</span>
        <span class="hljs-keyword">else</span> {
            status &lt;- getStatus(<span class="hljs-string">"run to influence area"</span>);
            <span class="hljs-keyword">do</span> run_to(influence_area.location);
        }
    }
    
    <span class="hljs-built_in">string</span> getStatus(<span class="hljs-built_in">string</span> str) {
        <span class="hljs-keyword">return</span> wing + <span class="hljs-string">" "</span> + role + <span class="hljs-string">"| action : "</span> + str;
    }
    
}

species intelligentTeam <span class="hljs-keyword">parent</span>:base_team {
    <span class="hljs-comment">// READ ONLY ATTRIBUTES :</span>
    <span class="hljs-comment">// position : can be "front" or "back".</span>
    <span class="hljs-comment">// players : list of all the players of the team.</span>
    <span class="hljs-comment">// game.</span>
    <span class="hljs-comment">// closest_player_to_ball.</span>
    <span class="hljs-comment">// called_player : the player called for a pass.</span>
    <span class="hljs-comment">// possess_ball : true when a player of the team possess the ball.</span>
    <span class="hljs-comment">// player_with_ball</span>
    
    <span class="hljs-comment">// READ AND WRITE ATTRIBUTES :</span>
    <span class="hljs-comment">// player_init_position</span>
    
    <span class="hljs-comment">// initial position of the player in percentage : for each point,</span>
    <span class="hljs-comment">//    the first value corresponds to the percentage from left to right (0 for the point the most in the left side)</span>
    <span class="hljs-comment">//    the second value corresponds to the percentage from the goal position to the mid position (0 for the goal position)</span>
    <span class="hljs-built_in">list</span>&lt;point&gt; player_init_position &lt;- <span class="hljs-meta">[</span>{<span class="hljs-number">20</span>,<span class="hljs-number">20</span>},{<span class="hljs-number">50</span>,<span class="hljs-number">20</span>},{<span class="hljs-number">80</span>,<span class="hljs-number">20</span>},{<span class="hljs-number">30</span>,<span class="hljs-number">50</span>},{<span class="hljs-number">70</span>,<span class="hljs-number">50</span>},{<span class="hljs-number">50</span>,<span class="hljs-number">70</span>},{<span class="hljs-number">30</span>,<span class="hljs-number">90</span>},{<span class="hljs-number">50</span>,<span class="hljs-number">90</span>},{<span class="hljs-number">70</span>,<span class="hljs-number">90</span>}<span class="hljs-meta">]</span>;
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>