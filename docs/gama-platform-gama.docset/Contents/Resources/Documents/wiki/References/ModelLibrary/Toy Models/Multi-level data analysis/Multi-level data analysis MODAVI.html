<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Multi-level data analysis/Multi-level data analysis MODAVI --><head><meta charset="utf-8"><title>Multi level data analysis MODAVI</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="multi-level-data-analysis-modavi">Multi level data analysis MODAVI</h1>
<h1 id="modavi">Modavi</h1>
<p><em>Author : Arnaud Grignard</em></p>
<p>From a reference model with node of a given class, a spatial graph is created (or a barabasi graph if spatialGraph is set to false) in the advanced view to represent the interaction in the reference model.An abstract view/controller is created to summarize the interaction in the advanced viewin a macro graph and control the reference model by defining an action (user_command) for each macroNode and macroEdge.</p>
<p>Code of the model : </p>
<pre><code class="hljs processing">
model modavi
 
global {
    <span class="hljs-comment">//Graph of the agents</span>
    graph&lt;node_agent,edge_agent&gt; my_graph ;
    
    <span class="hljs-comment">//Number of agents to create</span>
    <span class="hljs-built_in">int</span> nbAgent parameter: <span class="hljs-string">'Number of Agents'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">1</span> &lt;- <span class="hljs-number">500</span> category: <span class="hljs-string">'Model'</span>;
    <span class="hljs-comment">//Number of value per class</span>
    <span class="hljs-built_in">int</span> nbValuePerClass parameter: <span class="hljs-string">'Number of value per class'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">1</span> <span class="hljs-built_in">max</span>:<span class="hljs-number">100</span> &lt;- <span class="hljs-number">15</span> category: <span class="hljs-string">'Model'</span>;
    <span class="hljs-comment">//Boolean to know if we display a spatial graph or not</span>
    bool spatialGraph parameter: <span class="hljs-string">'Spatial Graph'</span> &lt;- <span class="hljs-keyword">true</span> category: <span class="hljs-string">'Model'</span>;
    <span class="hljs-comment">//Distance to link two node agents</span>
    <span class="hljs-built_in">float</span> distance parameter: <span class="hljs-string">'Distance'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">1.0</span>&lt;- <span class="hljs-number">10.0</span> category: <span class="hljs-string">'Model'</span>;
    <span class="hljs-comment">//Threshold</span>
    <span class="hljs-built_in">int</span> threshold parameter: <span class="hljs-string">'Threshold'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">0</span> &lt;- <span class="hljs-number">0</span> category: <span class="hljs-string">'Model'</span>;

    <span class="hljs-comment">//Size of a node agent</span>
    <span class="hljs-built_in">int</span> nodeSize parameter: <span class="hljs-string">'Node size'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">1</span> &lt;- <span class="hljs-number">1</span> category: <span class="hljs-string">'Aspect'</span>;
    <span class="hljs-comment">//Size of a macro node agent</span>
    <span class="hljs-built_in">int</span> macroNodeSize parameter: <span class="hljs-string">'Macro Node size'</span> <span class="hljs-built_in">min</span>: <span class="hljs-number">1</span> &lt;- <span class="hljs-number">2</span> category: <span class="hljs-string">'Aspect'</span>;
    
    <span class="hljs-comment">//Number of type of class</span>
    <span class="hljs-built_in">int</span> nbTypeOfClass &lt;<span class="hljs-number">-1</span>;
    
    <span class="hljs-comment">//Zoom factor</span>
    <span class="hljs-built_in">int</span> zoomFactor &lt;- nbTypeOfClass;

    <span class="hljs-comment">//List of the different interaction matrices</span>
    list&lt;matrix&lt;<span class="hljs-built_in">int</span>&gt;&gt; interactionMatrix &lt;-list_with(nbTypeOfClass,matrix([<span class="hljs-number">0</span>]));
    <span class="hljs-comment">//Number maximum of edges</span>
    <span class="hljs-built_in">int</span> nbEdgeMax;
    
    <span class="hljs-comment">//Reflex to update the interaction matrix list</span>
    reflex updateInteractionMatrix{
        <span class="hljs-comment">//Ask for each edge agent to update it sources and destination to create the matrix</span>
        ask edge_agent{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{                                                          
                src &lt;- my_graph source_of(self);
                dest &lt;- my_graph target_of(self);
                <span class="hljs-built_in">int</span> tmp &lt;- (interactionMatrix[i]  at {(src.classVector[i]<span class="hljs-number">-1</span>),(dest.classVector[i]<span class="hljs-number">-1</span>)});
                interactionMatrix[i][src.classVector[i]<span class="hljs-number">-1</span>,dest.classVector[i]<span class="hljs-number">-1</span>] &lt;- (tmp+<span class="hljs-number">1</span>);
            }
        }
    }
    
    <span class="hljs-comment">//Reflex to compute te maximum number of edges</span>
    reflex computeNbEdgeMax{
        <span class="hljs-comment">//Number maximum of edges</span>
        nbEdgeMax &lt;<span class="hljs-number">-1</span>;
        <span class="hljs-comment">//Ask for each macro edge its aggregated link list number</span>
        ask macroEdge{
            <span class="hljs-keyword">if</span>(nbAggregatedLinkList[<span class="hljs-number">0</span>] &gt; nbEdgeMax){
                nbEdgeMax &lt;-nbAggregatedLinkList[<span class="hljs-number">0</span>];
            }   
        }
    }

    <span class="hljs-comment">//Initialization of the model</span>
    init {
        <span class="hljs-comment">//Initialization of the matrix</span>
        do InitInteractionMatrix;
        <span class="hljs-comment">//If we want a spatial graph in that case we create a graph according to their distance, else we create a barabasi albert graph</span>
        <span class="hljs-keyword">if</span>(spatialGraph){
            create node_agent number:nbAgent;
            my_graph &lt;- graph&lt;node_agent, edge_agent&gt;(as_distance_graph(node_agent, ([<span class="hljs-string">"distance"</span>::distance, <span class="hljs-string">"species"</span>::edge_agent])));
            
        }
        <span class="hljs-keyword">else</span>{
          my_graph &lt;- graph&lt;node_agent, edge_agent&gt;(generate_barabasi_albert(node_agent,edge_agent,nbAgent,<span class="hljs-number">2</span>,<span class="hljs-keyword">true</span>));    
        }
        
        <span class="hljs-comment">//For each node agent, we compute its class value</span>
        ask node_agent as list{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to:nbTypeOfClass<span class="hljs-number">-1</span>{
                classVector[i] &lt;- rnd(nbValuePerClass<span class="hljs-number">-1</span>)+<span class="hljs-number">1</span>;
            }       
        }

        <span class="hljs-built_in">int</span> i&lt;<span class="hljs-number">-1</span>;
        <span class="hljs-comment">//Creation of the macronode according to the number of value per class</span>
        create macroNode number: nbValuePerClass{    
            class &lt;-i;
            location &lt;- {(<span class="hljs-built_in">cos</span> (((class<span class="hljs-number">-1</span>)/nbValuePerClass)*<span class="hljs-number">360</span>)*<span class="hljs-number">50</span> +<span class="hljs-number">50</span>),(<span class="hljs-built_in">sin</span> (((class<span class="hljs-number">-1</span>)/nbValuePerClass)*<span class="hljs-number">360</span>)*<span class="hljs-number">50</span>+<span class="hljs-number">50</span>),<span class="hljs-number">0</span>};
            <span class="hljs-built_in">color</span> &lt;- hsb (i/nbValuePerClass,<span class="hljs-number">1.0</span>,<span class="hljs-number">1.0</span>);
            do updatemyNodes;
            i&lt;-i+<span class="hljs-number">1</span>; 
        }
        <span class="hljs-comment">//We finally create the macroGraph</span>
        create macroGraph;
     }
     <span class="hljs-comment">//Action to initialize the interaction Matrix according to the number of type of classes</span>
     action InitInteractionMatrix{
         <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to:nbTypeOfClass<span class="hljs-number">-1</span>{
                interactionMatrix[i] &lt;- <span class="hljs-number">0</span> as_matrix({nbValuePerClass,nbValuePerClass});
          } 
    }
}


    <span class="hljs-comment">//Species to represent the node_agent</span>
    species node_agent  {
        <span class="hljs-comment">//Color of the node agent</span>
        rgb <span class="hljs-built_in">color</span>;
        <span class="hljs-comment">//List of the class</span>
        list&lt;<span class="hljs-built_in">int</span>&gt; classVector &lt;- list_with (nbTypeOfClass,<span class="hljs-number">0</span>);
        <span class="hljs-comment">//List of the position</span>
        list&lt;<span class="hljs-built_in">point</span>&gt; posVector &lt;- list_with (nbTypeOfClass,{<span class="hljs-number">0</span>,<span class="hljs-number">0</span>});
        <span class="hljs-comment">//List of the color</span>
        list&lt;rgb&gt; colorList &lt;- list_with (nbTypeOfClass, rgb(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>));
                                
        <span class="hljs-comment">//Shuffle the classes of the node_agent</span>
        reflex shuffleClass{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{
                classVector[i] &lt;- rnd(nbValuePerClass<span class="hljs-number">-1</span>)+<span class="hljs-number">1</span>;
            }   
        }
        
        aspect real {            
            <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>(nodeSize) <span class="hljs-built_in">color</span>: colorList[<span class="hljs-number">0</span>];
        } 
                                
        aspect coloredByClass{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{
                colorList[i]&lt;- hsb (classVector[i]/nbValuePerClass,<span class="hljs-number">1.0</span>,<span class="hljs-number">1.0</span>);                    
                posVector[i] &lt;- {(location.x+i*<span class="hljs-number">110</span>)*(<span class="hljs-number">1</span>/zoomFactor),(location.y)*(<span class="hljs-number">1</span>/zoomFactor),<span class="hljs-number">0</span>};  
                <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>(nodeSize/zoomFactor) <span class="hljs-built_in">color</span>: colorList[i] at: posVector[i] ;   
            }
        }
    
    }
    
    <span class="hljs-comment">//Species edge_agent to represent the edge of the graph</span>
    species edge_agent { 
        rgb <span class="hljs-built_in">color</span>;
        <span class="hljs-comment">//Source of the edge</span>
        node_agent src;
        <span class="hljs-comment">//Target of the edge</span>
        node_agent dest;
             
        aspect base {
            <span class="hljs-title">draw</span> <span class="hljs-built_in">shape</span> <span class="hljs-built_in">color</span>: rgb(<span class="hljs-number">125</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>);
        }   
        
        aspect edgeGenericSpatialized{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{
              <span class="hljs-keyword">if</span> ((src != nil) and (dest !=nil) ){
                <span class="hljs-title">draw</span> <span class="hljs-built_in">line</span>( [ (src.posVector[i]) , (dest.posVector[i])] ) <span class="hljs-built_in">color</span>:rgb(<span class="hljs-number">125</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>);
              }
            }
        }
    }
    <span class="hljs-comment">//Species representing the macro node agents</span>
    species macroNode{
        rgb <span class="hljs-built_in">color</span>;
        <span class="hljs-built_in">int</span> class;
        <span class="hljs-comment">//List of all the aggregated nodes</span>
        list&lt;<span class="hljs-built_in">int</span>&gt; nbAggregatedNodes &lt;- list_with(nbTypeOfClass,<span class="hljs-number">0</span>);
        <span class="hljs-comment">//List of all the position</span>
        list&lt;<span class="hljs-built_in">point</span>&gt; posVector &lt;-list_with(nbTypeOfClass,{<span class="hljs-number">0</span>,<span class="hljs-number">0</span>});
         
        <span class="hljs-comment">//Update the nodes of the agents</span>
        reflex update{
            do updatemyNodes;
        }
        <span class="hljs-comment">//For each classes, find all the nodes with the same classes</span>
        action updatemyNodes{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{          
                nbAggregatedNodes[i]&lt;<span class="hljs-number">-0</span>;
                ask node_agent as list{
                  <span class="hljs-keyword">if</span>    (classVector[i] = myself.class) {
                    myself.nbAggregatedNodes[i] &lt;- myself.nbAggregatedNodes[i]+<span class="hljs-number">1</span>;
                  }  
                }
            }       
        } 
        
        aspect <span class="hljs-built_in">sphere</span>{
            <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>((nbAggregatedNodes[<span class="hljs-number">0</span>]/<span class="hljs-number">10</span>)*macroNodeSize) <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span> at: <span class="hljs-built_in">point</span>([location.x,location.y]) ;
        }
        
        aspect Generic{
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>
            {
            posVector[i] &lt;- {(location.x+i*<span class="hljs-number">150</span>)*(<span class="hljs-number">1</span>/zoomFactor),(location.y)*(<span class="hljs-number">1</span>/zoomFactor),<span class="hljs-number">0</span>};  
            <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>((nbAggregatedNodes[i]/<span class="hljs-number">10</span>)*macroNodeSize*(<span class="hljs-number">1</span>/zoomFactor)) <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span> at: posVector[i] ;
            }
        }
        
        <span class="hljs-comment">//This action only works when having nbTypeOfClass=1</span>
        action removeMicroNode{
            ask node_agent as list{
                  <span class="hljs-keyword">if</span>    (classVector[<span class="hljs-number">0</span>] = myself.class) {
                      do die;
                  }  
             }
        }
        
        user_command <span class="hljs-string">"Remove all micro node"</span> action: removeMicroNode;
    }
    
    <span class="hljs-comment">//Species macroEdge representing the macro edges agents</span>
    species macroEdge  { 
        rgb <span class="hljs-built_in">color</span> &lt;- #black;
        <span class="hljs-comment">//Source of the macroedge</span>
        macroNode src;
        <span class="hljs-comment">//Destination of the macroedge</span>
        macroNode dest;
        <span class="hljs-comment">//List of all the aggregated links</span>
        list&lt;<span class="hljs-built_in">int</span>&gt; nbAggregatedLinkList &lt;- list_with(nbTypeOfClass,<span class="hljs-number">0</span>);
        
        aspect base {
            <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{
                <span class="hljs-keyword">if</span>(nbAggregatedLinkList[i]&gt;threshold){
                <span class="hljs-title">draw</span> (<span class="hljs-built_in">line</span>([src.posVector[i],dest.posVector[i]]) buffer ((nbAggregatedLinkList[i])/((length(edge_agent)))*nbEdgeMax)) <span class="hljs-built_in">color</span>: rgb(<span class="hljs-number">125</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>) border:rgb(<span class="hljs-number">125</span>,<span class="hljs-number">125</span>,<span class="hljs-number">125</span>);  
                }
            }
        }
        
        <span class="hljs-comment">//Action to remove a micro edge</span>
        action removeMicroEdge{
            ask edge_agent as list{
                  <span class="hljs-keyword">if</span>    ((self.src.classVector[<span class="hljs-number">0</span>] =  myself.src.class) and (self.dest.classVector[<span class="hljs-number">0</span>] =  myself.dest.class)) {
                      do die;
                  }  
             }
        }
        
        user_command <span class="hljs-string">"Remove all micro edge"</span> action: removeMicroEdge;   
    }
    
    <span class="hljs-comment">//Species macroGraph representing the macro graph composed of macroNode and macroEdge</span>
    species macroGraph {
        

    <span class="hljs-comment">//Reflex to update the graph by killing all the previous edges first </span>
   reflex updateAllMacroEdge {  
        ask macroEdge as list{
            do die;
        }
        
        <span class="hljs-built_in">loop</span> h from:<span class="hljs-number">0</span> to: nbTypeOfClass<span class="hljs-number">-1</span>{
            <span class="hljs-built_in">loop</span> i from: <span class="hljs-number">0</span> to: nbValuePerClass<span class="hljs-number">-1</span>{
              <span class="hljs-built_in">loop</span> j from: <span class="hljs-number">0</span> to: nbValuePerClass<span class="hljs-number">-1</span>{
                <span class="hljs-built_in">int</span> tmp &lt;- interactionMatrix[h] at {i,j}; 

                <span class="hljs-keyword">if</span>(i!=j){
                    create macroEdge{
                      nbAggregatedLinkList[h] &lt;- tmp;
                      src &lt;- macroNode[i];
                      dest &lt;- macroNode[j];
                    }     
                }      
              }
            }
        }
    }
    <span class="hljs-comment">//Reflex to initialize the matrix</span>
    reflex initMatrix{
        <span class="hljs-built_in">loop</span> i from:<span class="hljs-number">0</span> to:nbTypeOfClass<span class="hljs-number">-1</span>{
          interactionMatrix[i] &lt;- <span class="hljs-number">0</span> as_matrix({nbValuePerClass,nbValuePerClass});   
        }   
      } 
    }



experiment MODAVI type: gui {
    output {            
        display MODAVI type:opengl draw_env:<span class="hljs-keyword">false</span> {
            graphics <span class="hljs-string">'ReferenceModel'</span>{
                <span class="hljs-title">draw</span> <span class="hljs-string">"Reference model"</span> at:{<span class="hljs-number">200</span>,<span class="hljs-number">50</span>,<span class="hljs-number">0</span>} <span class="hljs-built_in">size</span>:<span class="hljs-number">5</span> <span class="hljs-built_in">color</span>: #black <span class="hljs-built_in">perspective</span>:<span class="hljs-keyword">false</span>;
            }
            species node_agent aspect: real position:{<span class="hljs-number">100</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.01</span>} ;
            
            graphics <span class="hljs-string">'View1'</span>{
                <span class="hljs-title">draw</span> <span class="hljs-string">"Advanced view"</span> at:{<span class="hljs-number">50</span>,<span class="hljs-number">210</span>,<span class="hljs-number">0</span>} <span class="hljs-built_in">size</span>:<span class="hljs-number">5</span> <span class="hljs-built_in">color</span>: #black <span class="hljs-built_in">perspective</span>:<span class="hljs-keyword">false</span>;
            }
            species node_agent aspect: coloredByClass position: {<span class="hljs-number">0</span>,<span class="hljs-number">100</span>,<span class="hljs-number">0.02</span>};
            species edge_agent aspect: edgeGenericSpatialized position: {<span class="hljs-number">0</span>,<span class="hljs-number">100</span>,<span class="hljs-number">0.02</span>};
            
            graphics <span class="hljs-string">'AbstractView'</span>{
                <span class="hljs-title">draw</span> <span class="hljs-string">"Abstract view/controller"</span> at:{<span class="hljs-number">250</span>,<span class="hljs-number">210</span>,<span class="hljs-number">0</span>} <span class="hljs-built_in">size</span>:<span class="hljs-number">5</span> <span class="hljs-built_in">color</span>: #black <span class="hljs-built_in">perspective</span>:<span class="hljs-keyword">false</span>;
            }
            species macroNode aspect:Generic position: {<span class="hljs-number">200</span>,<span class="hljs-number">100</span>,<span class="hljs-number">0.01</span>};
            species macroEdge aspect:base position: {<span class="hljs-number">200</span>,<span class="hljs-number">100</span>,<span class="hljs-number">0.01</span>}; 
        }
    }       
}


</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>