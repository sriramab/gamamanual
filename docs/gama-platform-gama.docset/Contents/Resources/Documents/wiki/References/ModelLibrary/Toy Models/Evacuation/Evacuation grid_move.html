<html><!-- Online page at https://github.com/gama-platform/gama/wiki/References/ModelLibrary/Toy Models/Evacuation/Evacuation grid_move --><head><meta charset="utf-8"><title>Evacuation grid_move</title><script src="../../../../../dash_resources/highlight.all.js"></script><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/github-markdown.css"><link rel="stylesheet" type="text/css" href="../../../../../dash_resources/highlightjs.github.css"></head><body class="markdown-body" style="padding-bottom:20px; margin: 8px 13px;"><h1 id="evacuation-grid_move">Evacuation grid_move</h1>
<h1 id="grid_move">grid_move</h1>
<p>_Author : _</p>
<p>A 3D model which show how to represent an evacuation system with obstacles, cohesion factor and velocity. The people are placed randomly and have to escape by going to a target point, within a discretized space by a grid. The agents don't use the skill moving to move.</p>
<p>![F:\Gama\GamaWiki\resources\images\modelLibraryScreenshots\Toy Models\Evacuation\Evacuation grid_move\map-10.png](F:\Gama\GamaWiki\resources\images\modelLibraryScreenshots\Toy Models\Evacuation\Evacuation grid_move\map-10.png)</p>
<p>Code of the model : </p>
<pre><code class="hljs processing">model grid_move

global {
    <span class="hljs-comment">//Shapefile of the buildings</span>
    file building_shapefile &lt;- file(<span class="hljs-string">"../includes/building.shp"</span>);
    <span class="hljs-comment">//Shape of the world</span>
    geometry <span class="hljs-built_in">shape</span> &lt;- envelope(building_shapefile);
    <span class="hljs-comment">//Maximum memory of the agent to avoid loop of the agents</span>
    <span class="hljs-built_in">int</span> max_memory &lt;- <span class="hljs-number">5</span>;
    <span class="hljs-comment">//Size of the people agents</span>
    <span class="hljs-built_in">float</span> people_size &lt;- <span class="hljs-number">2.0</span>;
    <span class="hljs-comment">//Number of people agents</span>
    <span class="hljs-built_in">int</span> nb_people &lt;- <span class="hljs-number">500</span>;
    <span class="hljs-comment">//Evacuation point for the people agents</span>
    <span class="hljs-built_in">point</span> target_point &lt;- {world.location.x, <span class="hljs-number">0</span>};
    
    init {
        <span class="hljs-comment">//Creation of the building agents using the shapefile</span>
        create building from: building_shapefile
        {
            <span class="hljs-comment">//Initialization of the cell is_obstacle attribute</span>
            ask cell overlapping self {
                is_obstacle &lt;- <span class="hljs-keyword">true</span>;
                <span class="hljs-built_in">color</span> &lt;- #black;
            }
        }

        list&lt;cell&gt; free_cell &lt;- cell where not (each.is_obstacle);
        cell the_target_cell &lt;- cell closest_to target_point;
        <span class="hljs-comment">//Creation of the people agent</span>
        create people number: nb_people {
            <span class="hljs-comment">//People agent are placed randomly among the cells which haven't people or obstacle</span>
            current_cell &lt;- one_of(free_cell);
            current_cell.is_free &lt;- <span class="hljs-keyword">false</span>;
            remove current_cell from: free_cell;
            location &lt;- current_cell.location;
            target_cell &lt;- the_target_cell;
            memory &lt;&lt; current_cell;
            
        }
    }
}
<span class="hljs-comment">//Species which represent the buildings</span>
species building {
    <span class="hljs-built_in">float</span> <span class="hljs-built_in">height</span> &lt;- <span class="hljs-number">3.0</span> + rnd(<span class="hljs-number">5</span>);
    aspect <span class="hljs-keyword">default</span> {
        <span class="hljs-title">draw</span> <span class="hljs-built_in">shape</span> <span class="hljs-built_in">color</span>: #gray depth: <span class="hljs-built_in">height</span>;
    }
}
<span class="hljs-comment">//Species which represent the people agent moving from one cell to its neighbours</span>
species people {
    <span class="hljs-comment">//Current cell of the agent</span>
    cell current_cell;
    <span class="hljs-comment">//Evacuation cell of the agent</span>
    cell target_cell;
    <span class="hljs-comment">//List of the cells already passed by the agents and mesmorized</span>
    list&lt;cell&gt; memory;
    <span class="hljs-comment">//Size of the agent</span>
    <span class="hljs-built_in">float</span> <span class="hljs-built_in">size</span> &lt;- people_size;
    rgb <span class="hljs-built_in">color</span> &lt;- rgb(rnd(<span class="hljs-number">255</span>),rnd(<span class="hljs-number">255</span>),rnd(<span class="hljs-number">255</span>));
    
    
    <span class="hljs-comment">//Reflex to kill the agent once it is close enough to an evacuation point</span>
    reflex end when: location distance_to target_cell.location &lt;= <span class="hljs-number">2</span> * people_size {
        current_cell.is_free &lt;- <span class="hljs-keyword">true</span>;
        do die;
    }
    <span class="hljs-comment">//Reflex to move the agent</span>
    reflex move {
        <span class="hljs-comment">//List of all the cells possible (which aren't obstacles, without people on it and on which the agent hasn't already passed</span>
        list&lt;cell&gt; possible_cells &lt;- current_cell neighbors_at <span class="hljs-number">1</span> where (not (each.is_obstacle) and each.is_free and not (each in memory));
        <span class="hljs-comment">//If there is possible cell, the agent move on the closest one to the evacuation point</span>
        <span class="hljs-keyword">if</span> not empty(possible_cells) {
            current_cell.is_free &lt;- <span class="hljs-keyword">true</span>;
            current_cell &lt;- shuffle(possible_cells) with_min_of (each.location distance_to target_cell.location);
            location &lt;- current_cell.location;
            current_cell.is_free &lt;- <span class="hljs-keyword">false</span>;
            <span class="hljs-comment">//Management of the memory of the agents</span>
            memory &lt;&lt; current_cell; 
            <span class="hljs-keyword">if</span> (length(memory) &gt; max_memory) {
                remove memory[<span class="hljs-number">0</span>] from: memory;
            }
        }
    }
    
    aspect <span class="hljs-keyword">default</span> {
        <span class="hljs-title">draw</span> pyramid(<span class="hljs-built_in">size</span>) <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span>;
        <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>(<span class="hljs-built_in">size</span>/<span class="hljs-number">3</span>) at: {location.x,location.y,<span class="hljs-built_in">size</span>} <span class="hljs-built_in">color</span>: <span class="hljs-built_in">color</span>;
    }
}
<span class="hljs-comment">//Grid species to discretize space</span>
grid cell <span class="hljs-built_in">width</span>: <span class="hljs-number">150</span> <span class="hljs-built_in">height</span>: <span class="hljs-number">150</span>  neighbors: <span class="hljs-number">8</span> frequency: <span class="hljs-number">0</span> {
    bool is_obstacle &lt;- <span class="hljs-keyword">false</span>;
    bool is_free &lt;- <span class="hljs-keyword">true</span>;
    rgb <span class="hljs-built_in">color</span> &lt;- #white;
}

experiment main type: gui {
    parameter <span class="hljs-string">"nb people"</span> var: nb_people <span class="hljs-built_in">min</span>: <span class="hljs-number">1</span> <span class="hljs-built_in">max</span>: <span class="hljs-number">1000</span>;
    output {
        display <span class="hljs-built_in">map</span> type: opengl camera_pos: {world.location.x,-world.<span class="hljs-built_in">shape</span>.<span class="hljs-built_in">height</span>*<span class="hljs-number">1.5</span>,<span class="hljs-number">70</span>}
                        camera_look_pos:{world.location.x,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>}    {
            <span class="hljs-built_in">image</span> <span class="hljs-string">'../images/soil.jpg'</span>;
            species building refresh: <span class="hljs-keyword">false</span>;
            species people;
            graphics <span class="hljs-string">"exit"</span> refresh: <span class="hljs-keyword">false</span> {
                <span class="hljs-title">draw</span> <span class="hljs-built_in">sphere</span>(<span class="hljs-number">2</span> * people_size) at: target_point <span class="hljs-built_in">color</span>: #<span class="hljs-built_in">green</span>;    
            }
        }
    }
}
</code></pre>
<script>hljs.initHighlightingOnLoad();</script></body></html>